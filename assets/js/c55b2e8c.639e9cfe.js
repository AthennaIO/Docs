"use strict";(self.webpackChunk_athenna_docs=self.webpackChunk_athenna_docs||[]).push([[5303],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return u}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function d(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var o=a.createContext({}),s=function(e){var t=a.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):d(d({},t),e)),n},c=function(e){var t=s(e.components);return a.createElement(o.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,o=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),m=s(n),u=r,h=m["".concat(o,".").concat(u)]||m[u]||p[u]||i;return n?a.createElement(h,d(d({ref:t},c),{},{components:n})):a.createElement(h,d({ref:t},c))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,d=new Array(i);d[0]=m;var l={};for(var o in t)hasOwnProperty.call(t,o)&&(l[o]=t[o]);l.originalType=e,l.mdxType="string"==typeof e?e:r,d[1]=l;for(var s=2;s<i;s++)d[s]=n[s];return a.createElement.apply(null,d)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},8031:function(e,t,n){n.r(t),n.d(t,{contentTitle:function(){return o},default:function(){return m},frontMatter:function(){return l},metadata:function(){return s},toc:function(){return c}});var a=n(7462),r=n(3366),i=(n(7294),n(3905)),d=["components"],l={sidebar_position:2,id:"middlewares",title:"Middlewares",hide_title:!0,hide_table_of_contents:!0,tags:["Getting Started","Architecture Concepts","The Basics"]},o=void 0,s={unversionedId:"the-basics/http/middlewares",id:"the-basics/http/middlewares",title:"Middlewares",description:"\ud83c\udfe0",source:"@site/docs/the-basics/http/middlewares.mdx",sourceDirName:"the-basics/http",slug:"/the-basics/http/middlewares",permalink:"/docs/the-basics/http/middlewares",editUrl:"https://github.com/AthennaIO/Docs/docs/the-basics/http/middlewares.mdx",tags:[{label:"Getting Started",permalink:"/docs/tags/getting-started"},{label:"Architecture Concepts",permalink:"/docs/tags/architecture-concepts"},{label:"The Basics",permalink:"/docs/tags/the-basics"}],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2,id:"middlewares",title:"Middlewares",hide_title:!0,hide_table_of_contents:!0,tags:["Getting Started","Architecture Concepts","The Basics"]},sidebar:"tutorialSidebar",previous:{title:"Routing",permalink:"/docs/the-basics/http/routing"},next:{title:"Controllers",permalink:"/docs/the-basics/http/controllers"}},c=[{value:"Introduction",id:"id-introduction",children:[],level:2},{value:"Defining middleware",id:"id-defining-middleware",children:[],level:2},{value:"Registering middleware",id:"id-registering-middleware",children:[{value:"Global middleware",id:"id-global-middleware",children:[],level:3},{value:"Assigning middleware to routes",id:"assigning-middleware-to-routes",children:[],level:3}],level:2},{value:"Intercept middleware",id:"id-intercept-middleware",children:[],level:2},{value:"Terminate middleware",id:"id-terminate-middleware",children:[],level:2}],p={toc:c};function m(e){var t=e.components,n=(0,r.Z)(e,d);return(0,i.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("nav",{"aria-label":"breadcrumbs"},(0,i.kt)("ul",{class:"breadcrumbs"},(0,i.kt)("li",{class:"breadcrumbs__item"},(0,i.kt)("a",{class:"breadcrumbs__link",href:"/"},"\ud83c\udfe0")),(0,i.kt)("li",{class:"breadcrumbs__item"},(0,i.kt)("a",{class:"breadcrumbs__link"},"The Basics")),(0,i.kt)("li",{class:"breadcrumbs__item"},(0,i.kt)("a",{class:"breadcrumbs__link"},"Http")),(0,i.kt)("li",{class:"breadcrumbs__item"},(0,i.kt)("a",{class:"breadcrumbs__link",href:"/docs/the-basics/http/middlewares"},"Middlewares")))),(0,i.kt)("span",{class:"badge badge--secondary margin-top-bot"},"version 1.0.0"),(0,i.kt)("h1",{id:"middlewares"},"Middlewares"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("h4",{parentName:"li",id:"introduction"},(0,i.kt)("a",{parentName:"h4",href:"#id-introduction"},"Introduction"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("h4",{parentName:"li",id:"defining-middleware"},(0,i.kt)("a",{parentName:"h4",href:"#id-defining-middleware"},"Defining middleware"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("h4",{parentName:"li",id:"registering-middleware"},(0,i.kt)("a",{parentName:"h4",href:"#id-registering-middleware"},"Registering middleware")),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("h4",{parentName:"li",id:"global-middleware"},(0,i.kt)("a",{parentName:"h4",href:"#id-global-middleware"},"Global middleware"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("h4",{parentName:"li",id:"assigning-middleware-to-routes"},(0,i.kt)("a",{parentName:"h4",href:"#id-assigning-middleware-to-routes"},"Assigning middleware to routes"))))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("h4",{parentName:"li",id:"intercept-middleware"},(0,i.kt)("a",{parentName:"h4",href:"#id-intercept-middleware"},"Intercept middleware"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("h4",{parentName:"li",id:"terminate-middleware"},(0,i.kt)("a",{parentName:"h4",href:"#id-terminate-middleware"},"Terminate middleware")))),(0,i.kt)("h2",{id:"id-introduction"},"Introduction"),(0,i.kt)("p",null,"Middleware provide a convenient mechanism for inspecting and filtering HTTP requests entering your application. For\nexample, Athenna includes a middleware that verifies the user of your application is authenticated. If the user is not\nauthenticated, the middleware will throw an unauthorized error. However, if the user is authenticated, the middleware\nwill allow the request to proceed further into the application."),(0,i.kt)("p",null,"Additional middleware can be written to perform a variety of tasks besides authentication. For example, a logging\nmiddleware might log all incoming requests to your application."),(0,i.kt)("h2",{id:"id-defining-middleware"},"Defining middleware"),(0,i.kt)("p",null,"To create a new middleware, use the ",(0,i.kt)("inlineCode",{parentName:"p"},"make:middleware")," command:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"node artisan make:middleware EnsureApiKeyIsValid\n")),(0,i.kt)("p",null,"This command will place a new ",(0,i.kt)("inlineCode",{parentName:"p"},"EnsureApiKeyIsValid")," class within your ",(0,i.kt)("inlineCode",{parentName:"p"},"app/Http/Middlewares")," directory. In this middleware,\nwe will only allow access to the route if the supplied api key input matches a specified value. Otherwise, we will throw an\nunauthorized exception:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"import { UnauthorizedException } from '@athenna/http'\n\nexport class EnsureApiKeyIsValid {\n  /**\n   * Use the constructor to resolve any dependency of the Ioc container.\n   */\n  constructor() {}\n\n  /**\n    * Handle method is executed before the request gets in your controller.\n    *\n    * @param {import('@athenna/http').HandleContextContract} ctx\n    * @return {any}\n    */\n  async handle({ queries }) {\n    if (queries.apiKey !== 'my-api-key') {\n        throw new UnauthorizedException('Your api key does not match with application api key.')\n    }\n  }\n}\n")),(0,i.kt)("p",null,"As you can see, if the given ",(0,i.kt)("inlineCode",{parentName:"p"},"apiKey")," does not match our application api key, the middleware will return an unauthorized\nexception to the client; otherwise, the request will be passed further into the application."),(0,i.kt)("p",null,'It\'s best to envision middleware as a series of "layers" HTTP requests must pass through before they hit your application.\nEach layer can examine the request and even reject it entirely.'),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"All middleware are resolved via the ",(0,i.kt)("a",{parentName:"p",href:"/docs/architecture-concepts/container"},(0,i.kt)("inlineCode",{parentName:"a"},"service container")),", so you can use any\ndependencies you need within a middlewares constructor."))),(0,i.kt)("h2",{id:"id-registering-middleware"},"Registering middleware"),(0,i.kt)("h3",{id:"id-global-middleware"},"Global middleware"),(0,i.kt)("p",null,"If you want a middleware to run during every HTTP request to your application, list the middleware class in the ",(0,i.kt)("inlineCode",{parentName:"p"},"globalMiddlewares"),"\nproperty of your ",(0,i.kt)("inlineCode",{parentName:"p"},"app/Http/Kernel.js")," class."),(0,i.kt)("h3",{id:"assigning-middleware-to-routes"},"Assigning middleware to routes"),(0,i.kt)("p",null,"If you would like to assign middleware to specific routes, you should first assign the middleware a key in your application's\n",(0,i.kt)("inlineCode",{parentName:"p"},"app/Http/Kernel.js")," file. You can do that inside ",(0,i.kt)("inlineCode",{parentName:"p"},"namedMiddlewares")," property, you may add your own middleware to this list\nand assign it a key of your choosing:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"// Within app\\Http\\Kernel class...\n\nget namedMiddlewares() {\n    return {\n        myMiddleware: import('App/Http/Middlewares/MyMiddleware')\n    }\n}\n")),(0,i.kt)("p",null,"Once the middleware has been defined in the HTTP kernel, you may use the ",(0,i.kt)("inlineCode",{parentName:"p"},"middleware")," method to assign middleware to a route:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"Route.get('/welcome', () => {\n    //\n}).middleware('myMiddleware')\n")),(0,i.kt)("h2",{id:"id-intercept-middleware"},"Intercept middleware"),(0,i.kt)("p",null,"Sometimes a middleware may need to do some work before the HTTP response has been sent to the client. If you define an\n",(0,i.kt)("inlineCode",{parentName:"p"},"intercept")," method on your middleware, the ",(0,i.kt)("inlineCode",{parentName:"p"},"intercept")," method will automatically be called before the response is sent to\nthe client:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"export class InterceptMiddleware {\n  /**\n   * Use the constructor to resolve any dependency of the Ioc container.\n   */\n  constructor() {}\n\n  /**\n    * Handle method is executed before the request gets in your controller.\n    *\n    * @param {import('@athenna/http').HandleContextContract} ctx\n    */\n  async handle() {\n  }\n\n  /**\n    * Intercept method is executed before the response has been sent.\n    *\n    * @param {import('@athenna/http').InterceptContextContract} ctx\n    */\n  async intercept({ body }) {\n    body.intercepted = true\n\n    // intercept should always return the new body of the response\n    return body\n  }\n}\n")),(0,i.kt)("p",null,"Once you have defined a intercept middleware, you should add it to the list of routes or global middleware in the ",(0,i.kt)("inlineCode",{parentName:"p"},"app/Http/Kernel.js")," file."),(0,i.kt)("h2",{id:"id-terminate-middleware"},"Terminate middleware"),(0,i.kt)("p",null,"Sometimes a middleware may need to do some work after the HTTP response has been sent to the client. If you define a\n",(0,i.kt)("inlineCode",{parentName:"p"},"terminate")," method on your middleware, the ",(0,i.kt)("inlineCode",{parentName:"p"},"terminate")," method will automatically be called after the response is sent to\nthe client:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-javascript"},"export class TerminateMiddleware {\n  /**\n   * Use the constructor to resolve any dependency of the Ioc container.\n   */\n  constructor() {}\n\n  /**\n    * Handle method is executed before the request gets in your controller.\n    *\n    * @param {import('@athenna/http').HandleContextContract} ctx\n    */\n  async handle() {\n  }\n\n  /**\n    * Terminate method is executed after the response has been sent.\n    *\n    * @param {import('@athenna/http').TerminateContextContract} ctx\n    */\n  async terminate() {\n    // create and save metrics of the request\n  }\n}\n")),(0,i.kt)("p",null,"Once you have defined a terminable middleware, you should add it to the list of routes or global middleware in the ",(0,i.kt)("inlineCode",{parentName:"p"},"app/Http/Kernel")," file."),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"The requests log created by Athenna when the ",(0,i.kt)("inlineCode",{parentName:"p"},"logRequests")," property is true in your ",(0,i.kt)("inlineCode",{parentName:"p"},"config/http.js")," file are handled by a\nterminable middleware! You can see the code ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/AthennaIO/Http/blob/develop/src/Kernels/HttpKernel.js"},"here"),"."))))}m.isMDXComponent=!0}}]);