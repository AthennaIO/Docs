"use strict";(self.webpackChunk_athenna_docs=self.webpackChunk_athenna_docs||[]).push([[6546],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>m});var i=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,i,r=function(e,n){if(null==e)return{};var t,i,r={},a=Object.keys(e);for(i=0;i<a.length;i++)t=a[i],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)t=a[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=i.createContext({}),c=function(e){var n=i.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},p=function(e){var n=c(e.components);return i.createElement(l.Provider,{value:n},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},h=i.forwardRef((function(e,n){var t=e.components,r=e.mdxType,a=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=c(t),h=r,m=d["".concat(l,".").concat(h)]||d[h]||u[h]||a;return t?i.createElement(m,o(o({ref:n},p),{},{components:t})):i.createElement(m,o({ref:n},p))}));function m(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var a=t.length,o=new Array(a);o[0]=h;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s[d]="string"==typeof e?e:r,o[1]=s;for(var c=2;c<a;c++)o[c]=t[c];return i.createElement.apply(null,o)}return i.createElement.apply(null,t)}h.displayName="MDXCreateElement"},9927:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>a,metadata:()=>s,toc:()=>c});var i=t(7462),r=(t(7294),t(3905));const a={title:"Service Container",sidebar_position:2,description:"Understand the purpose and how to use the Athenna service container."},o="Service Container",s={unversionedId:"architecture-concepts/service-container",id:"architecture-concepts/service-container",title:"Service Container",description:"Understand the purpose and how to use the Athenna service container.",source:"@site/docs/architecture-concepts/service-container.mdx",sourceDirName:"architecture-concepts",slug:"/architecture-concepts/service-container",permalink:"/docs/architecture-concepts/service-container",draft:!1,editUrl:"https://github.com/AthennaIO/Docs/tree/main/docs/architecture-concepts/service-container.mdx",tags:[],version:"current",sidebarPosition:2,frontMatter:{title:"Service Container",sidebar_position:2,description:"Understand the purpose and how to use the Athenna service container."},sidebar:"tutorialSidebar",previous:{title:"Application Lifecycle",permalink:"/docs/architecture-concepts/application-lifecycle"},next:{title:"Service Providers",permalink:"/docs/architecture-concepts/service-providers"}},l={},c=[{value:"Introduction",id:"introduction",level:2},{value:"Simple resolution",id:"simple-resolution",level:2},{value:"When to use the container",id:"when-to-use-the-container",level:2},{value:"Binding",id:"binding",level:2},{value:"Binding transients",id:"binding-transients",level:3},{value:"Binding a singleton",id:"binding-a-singleton",level:3},{value:"Binding instances",id:"binding-instances",level:3},{value:"The <code>@Service()</code> annotation",id:"the-service-annotation",level:3},{value:"Resolving",id:"resolving",level:2},{value:"Automatic constructor injection",id:"automatic-constructor-injection",level:3},{value:"Using <code>@Inject()</code> annotation",id:"using-inject-annotation",level:3}],p={toc:c},d="wrapper";function u(e){let{components:n,...t}=e;return(0,r.kt)(d,(0,i.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"service-container"},"Service Container"),(0,r.kt)("p",null,"Understand the purpose and how to use the Athenna service container."),(0,r.kt)("h2",{id:"introduction"},"Introduction"),(0,r.kt)("p",null,'The Athenna service container is a powerful tool for managing class dependencies\nand performing dependency injection. Dependency injection is a fancy phrase that\nessentially means this: class dependencies are "injected" into the class via the\nconstructor or, in some cases, "setter" methods.'),(0,r.kt)("p",null,"Let's look at a simple example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Controller, type Context } from '@athenna/http'\nimport { WelcomeService } from '#app/services/WelcomeService'\n\n@Controller()\nexport class WelcomeController {\n  private welcomeService: WelcomeService\n\n  public constructor(welcomeService) {\n    this.welcomeService = welcomeService\n  }\n\n  public async show({ response }: Context) {\n    const data = await this.welcomeService.getWelcomeData()\n\n    return response.status(200).send(data)\n  }\n}\n")),(0,r.kt)("p",null,"In this example, the ",(0,r.kt)("inlineCode",{parentName:"p"},"WelcomeController")," needs to retrieve the welcome payload\nfrom a data source. So, we will inject a service that is able to retrieve the\npayload. In this context, our ",(0,r.kt)("inlineCode",{parentName:"p"},"WelcomeService"),". Since the ",(0,r.kt)("inlineCode",{parentName:"p"},"WelcomeService")," is\ninjected, we are able to easily swap it out with another implementation. We are\nalso able to easily 'mock', or create a dummy implementation of the\n",(0,r.kt)("inlineCode",{parentName:"p"},"WelcomeService")," when testing our application."),(0,r.kt)("p",null,"A deep understanding of the Athenna service container is essential to building a\npowerful, large application, as well as for contributing to the Athenna core\nitself."),(0,r.kt)("h2",{id:"simple-resolution"},"Simple resolution"),(0,r.kt)("p",null,"You may place the following code in your ",(0,r.kt)("inlineCode",{parentName:"p"},"Path.routes('http.ts')"),"\nfile:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Route } from '@athenna/http'\n\nexport class AppService {\n  public ok() {\n    return { message: 'ok' }\n  }\n}\n\nioc.bind('appService', AppService)\n\nRoute.get('/', ({ response }) => {\n  const appService = ioc.use<AppService>('appService')\n  const body = appService.ok()\n\n  return response.status(200).send(body)\n})\n")),(0,r.kt)("p",null,"In this example, when bootstrapping your application, Athenna will bind the\n",(0,r.kt)("inlineCode",{parentName:"p"},"AppService")," class inside the container. When hitting your application's / route,\nit will be resolved by using the ",(0,r.kt)("inlineCode",{parentName:"p"},"ioc")," global variable. This is game changing. It\nmeans you can develop your application and take advantage of dependency\ninjection without worrying about bloated configuration files."),(0,r.kt)("p",null,"Thankfully, many of the classes you will be writing when building an Athenna\napplication automatically receive their dependencies via the container,\nincluding ",(0,r.kt)("a",{parentName:"p",href:"/docs/rest-api-application/controllers"},"controllers")," and\n",(0,r.kt)("a",{parentName:"p",href:"/docs/rest-api-application/middlewares"},"middlewares"),". Once you taste the power of\nautomatic and zero configuration dependency injection, it feels impossible to\ndevelop without it."),(0,r.kt)("admonition",{type:"important"},(0,r.kt)("p",{parentName:"admonition"},"The example above is just to show that we can place our services anywhere in our\napplication, without depending on configuration files or any other kind of\nsetup. We recommend you placing your services in specifics directory and not\ninside your route file. A good place to put your services is ",(0,r.kt)("inlineCode",{parentName:"p"},"app/services"),"\ndirectory, since ",(0,r.kt)("inlineCode",{parentName:"p"},"make:service")," command will save your services there.\nBut remember that this is only a tip, at the end of the day you can do\nwhatever you want with Athenna \ud83d\ude0e.")),(0,r.kt)("h2",{id:"when-to-use-the-container"},"When to use the container"),(0,r.kt)("p",null,"Thanks to this simple configuration resolution, you will often just import your\ndependency on your routes, controllers, and elsewhere without ever manually\ninteracting with the container. For example, you might just import your\n",(0,r.kt)("inlineCode",{parentName:"p"},"AppService")," in your controller so that you can easily access the business\nlogic wrote in the service class. Even though we never have to interact with\nthe container to write this code, it is managing the injection of their\ndependencies behind the scenes."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { AppService } from '#app/services/AppService'\nimport { Controller, type Context } from '@athenna/http'\n\n@Controller()\nexport class AppController {\n  public constructor(private appService: AppService) {}\n\n  public async show({ response }: Context) {\n    const data = await this.appService.getDate()\n\n    return response.status(200).send(data)\n  }\n}\n")),(0,r.kt)("p",null,"In many cases, thanks to automatic dependency injection and\n",(0,r.kt)("a",{parentName:"p",href:"/docs/architecture-concepts/facades"},"facades"),", you can build Athenna applications\nwithout ever manually binding or resolving anything from the container. ",(0,r.kt)("strong",{parentName:"p"},"So,\nwhen would you ever manually interact with the container?")),(0,r.kt)("p",null,"If you are writing an Athenna package that you plan to share with other Athenna\ndevelopers, you may need to bind your package's services into the container."),(0,r.kt)("h2",{id:"binding"},"Binding"),(0,r.kt)("p",null,"Almost all of your service container bindings will be registered within\nservice providers, so most of these examples will demonstrate using the\ncontainer in that context."),(0,r.kt)("p",null,"In your application you will always have access to the container via the ",(0,r.kt)("inlineCode",{parentName:"p"},"ioc"),"\nglobal property. We can register a binding using the ",(0,r.kt)("inlineCode",{parentName:"p"},"bind")," method, passing the\nalias name that we wish to register along with our dependency:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { StringNormalizer } from '#app/helpers/StringNormalizer'\n\nioc.bind('App/Helpers/StringNormalizer', StringNormalizer)\n")),(0,r.kt)("h3",{id:"binding-transients"},"Binding transients"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"transient")," method binds a class into the container that will resolve\ndifferent instances of it each time. Meaning that once a transient binding is\nresolved, a new object instance will be returned on subsequent calls into the\ncontainer:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { StringNormalizer } from '#app/helpers/StringNormalizer'\n\nioc.transient('App/Helpers/StringNormalizer', StringNormalizer)\n")),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"By default, the ",(0,r.kt)("inlineCode",{parentName:"p"},"bind")," method will always register your dependencies as\n",(0,r.kt)("inlineCode",{parentName:"p"},"transient"),".")),(0,r.kt)("h3",{id:"binding-a-singleton"},"Binding a singleton"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"singleton")," method binds a class into the container that should only be\nresolved one time. Once a singleton binding is resolved, the same object\ninstance will be returned on subsequent calls into the container:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { StringNormalizer } from '#app/helpers/StringNormalizer'\n\nioc.singleton('App/Helpers/StringNormalizer', StringNormalizer)\n")),(0,r.kt)("h3",{id:"binding-instances"},"Binding instances"),(0,r.kt)("p",null,"You may also bind an existing object instance into the container using the\n",(0,r.kt)("inlineCode",{parentName:"p"},"instance")," method. The given instance will always be returned on subsequent\ncalls into the container:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { StringNormalizer } from '#app/helpers/StringNormalizer'\n\nioc.instance('App/Helpers/StringNormalizer', new StringNormalizer())\n")),(0,r.kt)("h3",{id:"the-service-annotation"},"The ",(0,r.kt)("inlineCode",{parentName:"h3"},"@Service()")," annotation"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"@Service()")," annotation is just a helper that will map all the\nconfigurations that a service needs to be registered in the container,\nthis means that this annotation does not have the responsibility to\nbind your service in the container."),(0,r.kt)("p",null,"Let's create a simple service to understand how this annotation works:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"node artisan make:service StringNormalizer\n")),(0,r.kt)("p",null,"The command above will create the ",(0,r.kt)("inlineCode",{parentName:"p"},"Path.services('StringNormalizer.ts')"),"\nfile and will automatically register the service in the ",(0,r.kt)("inlineCode",{parentName:"p"},"services")," property\nof the ",(0,r.kt)("inlineCode",{parentName:"p"},".athennarc.json")," file."),(0,r.kt)("p",null,"Let's add some configuration to it:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"title=\"Path.services('StringNormalizer.ts')\"",title:"\"Path.services('StringNormalizer.ts')\""},"import { Service } from '@athenna/ioc'\n\n@Service({\n  type: 'singleton',\n  camelAlias: 'stringNormalizer',\n  alias: 'App/Services/StringNormalizer',\n})\nexport class StringNormalizer {\n  public run(value: string) {\n    return value.trim().toLowerCase()\n  }\n}\n")),(0,r.kt)("p",null,"The following operations will be done in ",(0,r.kt)("inlineCode",{parentName:"p"},"StringNormalizer")," class\nwhen bootstrapping the Athenna application:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"The class will be registered in the container with the\nalias ",(0,r.kt)("inlineCode",{parentName:"li"},"App/Services/StringNormalizer"),"."),(0,r.kt)("li",{parentName:"ol"},"The registration type will be ",(0,r.kt)("a",{parentName:"li",href:"/docs/architecture-concepts/service-container#binding-a-singleton"},"singleton"),", meaning\nthat the same instance of the class will be resolved from\nthe container everytime it is requested."),(0,r.kt)("li",{parentName:"ol"},"The camel alias of the class will be ",(0,r.kt)("inlineCode",{parentName:"li"},"stringNormalizer"),",\nthat is typically used in ",(0,r.kt)("a",{parentName:"li",href:"/docs/architecture-concepts/service-container#automatic-constructor-injection"},"automatic constructor injections"),"\nand also by ",(0,r.kt)("a",{parentName:"li",href:"/docs/architecture-concepts/service-container#using-inject-annotation"},"the ",(0,r.kt)("inlineCode",{parentName:"a"},"@Inject()")," annotation"),"\nto resolve the class from the container.")),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"By default, the ",(0,r.kt)("inlineCode",{parentName:"p"},"@Service()")," annotation will always register\nyour services as ",(0,r.kt)("a",{parentName:"p",href:"/docs/architecture-concepts/service-container#binding-transients"},"transient"),",\nmeaning that a new instance of your class will be resolved from the container\neverytime.")),(0,r.kt)("h2",{id:"resolving"},"Resolving"),(0,r.kt)("p",null,"You may use the ",(0,r.kt)("inlineCode",{parentName:"p"},"use")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"safeUse")," methods from the ioc global property to\nresolve a class instance from the container. The use method accepts the alias\nof the dependency you wish to resolve:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { StringNormalizer } from '#app/helpers/StringNormalizer'\n\nconst sn = ioc.use<StringNormalizer>('App/Helpers/StringNormalizer')\n")),(0,r.kt)("p",null,"If the dependency alias cannot be found in the container, ",(0,r.kt)("inlineCode",{parentName:"p"},"sn")," const will be\nset as ",(0,r.kt)("inlineCode",{parentName:"p"},"undefined"),". To throw errors when the dependency does not exist, use\nthe ",(0,r.kt)("inlineCode",{parentName:"p"},"safeUse")," method."),(0,r.kt)("h3",{id:"automatic-constructor-injection"},"Automatic constructor injection"),(0,r.kt)("p",null,"Alternatively, and importantly, you can use the constructor of a class that is\nresolved by the container, including\n",(0,r.kt)("a",{parentName:"p",href:"/docs/rest-api-application/controllers"},"controllers"),", ",(0,r.kt)("a",{parentName:"p",href:"/docs/rest-api-application/middlewares"},"middlewares"),",\nand more."),(0,r.kt)("p",null,"For example, you may add your provider name in camelCase in the controller's\nconstructor. The service will automatically be resolved and injected into the\nclass:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { AppService } from '#app/services/AppService'\nimport { Controller, type Context } from '@athenna/http'\n\n@Controller()\nexport class AppController {\n  public constructor(private appService: AppService) {}\n\n  public async show({ response }: Context) {\n    const data = await this.appService.getData()\n\n    return response.status(200).send(data)\n  }\n}\n")),(0,r.kt)("h3",{id:"using-inject-annotation"},"Using ",(0,r.kt)("inlineCode",{parentName:"h3"},"@Inject()")," annotation"),(0,r.kt)("p",null,"You can also use the ",(0,r.kt)("inlineCode",{parentName:"p"},"@Inject()")," annotation instead of the constructor. The\nannotation follows the same logic of the constructor, you need to use the\ncamelCase name of your dependency as the property name to be resolved properly:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Inject } from '@athenna/ioc'\nimport { AppService } from '#app/services/AppService'\nimport { Controller, type Context } from '@athenna/http'\n\n@Controller()\nexport class AppController {\n  @Inject()\n  private appService: AppService\n\n  public async show({ response }: Context) {\n    const data = await this.appService.getData()\n\n    return response.status(200).send(data)\n  }\n}\n")),(0,r.kt)("p",null,"When using the ",(0,r.kt)("inlineCode",{parentName:"p"},"@Inject()")," annotation you could also pass as argument a\nspecific alias to be resolved in the container:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Inject } from '@athenna/ioc'\nimport { AppService } from '#app/services/AppService'\nimport { Controller, type Context } from '@athenna/http'\n\n@Controller()\nexport class AppController {\n  @Inject('App/Services/AppService')\n  private appService: AppService\n\n  public async show({ response }: Context) {\n    const data = await this.appService.getData()\n\n    return response.status(200).send(data)\n  }\n}\n")))}u.isMDXComponent=!0}}]);