"use strict";(self.webpackChunk_athenna_docs=self.webpackChunk_athenna_docs||[]).push([[1535],{3905:(e,t,n)=>{n.d(t,{Zo:()=>s,kt:()=>h});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var d=a.createContext({}),p=function(e){var t=a.useContext(d),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},s=function(e){var t=p(e.components);return a.createElement(d.Provider,{value:t},e.children)},m="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,d=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),m=p(n),u=r,h=m["".concat(d,".").concat(u)]||m[u]||c[u]||i;return n?a.createElement(h,o(o({ref:t},s),{},{components:n})):a.createElement(h,o({ref:t},s))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=u;var l={};for(var d in t)hasOwnProperty.call(t,d)&&(l[d]=t[d]);l.originalType=e,l[m]="string"==typeof e?e:r,o[1]=l;for(var p=2;p<i;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},5210:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>o,default:()=>c,frontMatter:()=>i,metadata:()=>l,toc:()=>p});var a=n(7462),r=(n(7294),n(3905));const i={title:"Middlewares",sidebar_position:2,description:"Understand how you can set up middlewares in your REST API application."},o="Middlewares",l={unversionedId:"rest-api-application/middlewares",id:"rest-api-application/middlewares",title:"Middlewares",description:"Understand how you can set up middlewares in your REST API application.",source:"@site/docs/rest-api-application/middlewares.mdx",sourceDirName:"rest-api-application",slug:"/rest-api-application/middlewares",permalink:"/docs/rest-api-application/middlewares",draft:!1,editUrl:"https://github.com/AthennaIO/Docs/tree/main/docs/rest-api-application/middlewares.mdx",tags:[],version:"current",sidebarPosition:2,frontMatter:{title:"Middlewares",sidebar_position:2,description:"Understand how you can set up middlewares in your REST API application."},sidebar:"tutorialSidebar",previous:{title:"Routing",permalink:"/docs/rest-api-application/routing"},next:{title:"Controllers",permalink:"/docs/rest-api-application/controllers"}},d={},p=[{value:"Introduction",id:"introduction",level:2},{value:"Defining middleware",id:"defining-middleware",level:2},{value:"Registering middleware",id:"registering-middleware",level:2},{value:"Global middleware",id:"global-middleware",level:3},{value:"Assigning middleware to routes",id:"assigning-middleware-to-routes",level:3},{value:"Intercept middleware",id:"intercept-middleware",level:2},{value:"Terminate middleware",id:"terminate-middleware",level:2}],s={toc:p},m="wrapper";function c(e){let{components:t,...n}=e;return(0,r.kt)(m,(0,a.Z)({},s,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"middlewares"},"Middlewares"),(0,r.kt)("p",null,"Understand how you can set up middlewares in your REST\nAPI application."),(0,r.kt)("h2",{id:"introduction"},"Introduction"),(0,r.kt)("p",null,"Middleware provides a convenient mechanism for inspecting\nand filtering HTTP requests entering your application.\nFor example, Athenna includes a middleware that verifies\nthe user of your application is authenticated. If the user\nis not authenticated, the middleware will throw an\nunauthorized error. However, if the user is authenticated,\nthe middleware will allow the request to proceed further\ninto the application."),(0,r.kt)("p",null,"Additional middleware can be written to perform a variety\nof tasks besides authentication. For example, a logging\nmiddleware might log all incoming requests to your\napplication."),(0,r.kt)("h2",{id:"defining-middleware"},"Defining middleware"),(0,r.kt)("p",null,"To create a new middleware, use the ",(0,r.kt)("inlineCode",{parentName:"p"},"make:middleware"),"\ncommand:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"./node artisan make:middleware EnsureApiKeyIsValid\n")),(0,r.kt)("p",null,"This command will place a new ",(0,r.kt)("inlineCode",{parentName:"p"},"EnsureApiKeyIsValid")," class\nwithin your ",(0,r.kt)("inlineCode",{parentName:"p"},"app/http/middlewares")," directory. In this\nmiddleware, we will only allow access to the route if the\nsupplied api key input matches a specified value. Otherwise,\nwe will throw an unauthorized exception:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Context, Middleware, MiddlewareContract } from '@athenna/http'\n\n@Middleware()\nexport class EnsureApiKeyIsValid implements MiddlewareContract {\n    public async handle(ctx: Context): Promise<void> {\n        if (queries.apiKey !== 'my-api-key') {\n            throw new UnauthorizedException('Your api key does not match with application api key.')\n        }\n    }\n}\n")),(0,r.kt)("p",null,"As you can see, if the given ",(0,r.kt)("inlineCode",{parentName:"p"},"apiKey")," does not match our\napplication api key, the middleware will return an\nunauthorized exception to the client; otherwise, the\nrequest will be passed further into the application."),(0,r.kt)("p",null,'It\'s best to envision middleware as a series of "layers"\nHTTP requests must pass through before they hit your\napplication. Each layer can examine the request and even\nreject it entirely.'),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"All middleware is resolved via the ",(0,r.kt)("a",{parentName:"p",href:"/docs/architecture-concepts/container"},(0,r.kt)("inlineCode",{parentName:"a"},"service container")),",\nso you can use any dependencies you need within a\nmiddlewares constructor.")),(0,r.kt)("h2",{id:"registering-middleware"},"Registering middleware"),(0,r.kt)("p",null,"If you are using ",(0,r.kt)("inlineCode",{parentName:"p"},"make:middleware")," command to register your\nmiddlewares, Athenna will auto register your middlewares\ninside the ",(0,r.kt)("inlineCode",{parentName:"p"},"middlewares")," property of your ",(0,r.kt)("inlineCode",{parentName:"p"},".athennarc.json"),"\nfile:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "middlewares": [\n    "#app/http/middlewares/EnsureApiKeyIsValid"\n  ]\n}\n')),(0,r.kt)("admonition",{type:"warning"},(0,r.kt)("p",{parentName:"admonition"},"Remember that if you have not created your middleware using\n",(0,r.kt)("inlineCode",{parentName:"p"},"make:middleware")," command, you will need to manually add it\nto ",(0,r.kt)("inlineCode",{parentName:"p"},"middlewares")," array. If you don't do that, Athenna will\nnot register your middleware in the ",(0,r.kt)("a",{parentName:"p",href:"/docs/architecture-concepts/service-container"},"service container"),"\nand you will not be able to use it.")),(0,r.kt)("h3",{id:"global-middleware"},"Global middleware"),(0,r.kt)("p",null,"If you want a middleware to run during every HTTP request\nto your application, you can set the ",(0,r.kt)("inlineCode",{parentName:"p"},"isGlobal")," value to\ntrue in the ",(0,r.kt)("inlineCode",{parentName:"p"},"@Middleware")," annotation:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Middleware } from '@athenna/http'\nimport type { Context, MiddlewareContract } from '@athenna/http'\n\n@Middleware({ isGlobal: true }) \ud83d\udc48\nexport class EnsureApiKeyIsValid implements MiddlewareContract {\n    public async handle(ctx: Context): Promise<void> {\n        if (queries.apiKey !== 'my-api-key') {\n            throw new UnauthorizedException('Your api key does not match with application api key.')\n        }\n    }\n}\n")),(0,r.kt)("p",null,"If you are not using TypeScript, you can use the\n",(0,r.kt)("inlineCode",{parentName:"p"},"globalMiddlewares")," array in your ",(0,r.kt)("inlineCode",{parentName:"p"},".athennarc.json")," file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "globalMiddlewares": [\n    "#app/http/middlewares/EnsureApiKeyIsValid"\n  ]\n}\n')),(0,r.kt)("h3",{id:"assigning-middleware-to-routes"},"Assigning middleware to routes"),(0,r.kt)("p",null,"If you would like to assign middleware to specific routes,\nyou can use the name of your middleware class in camelCase\n(",(0,r.kt)("inlineCode",{parentName:"p"},"ensureApiKeyIsValid"),"). But we recommend you to assign a\ncustom name to your middleware using the ",(0,r.kt)("inlineCode",{parentName:"p"},"@Middleware"),"\nannotation:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Middleware } from '@athenna/http'\nimport type { Context, MiddlewareContract } from '@athenna/http'\n\n@Middleware({ name: 'auth' }) \ud83d\udc48\nexport class EnsureApiKeyIsValid implements MiddlewareContract {\n    public async handle(ctx: Context): Promise<void> {\n        if (queries.apiKey !== 'my-api-key') {\n            throw new UnauthorizedException('Your api key does not match with application api key.')\n        }\n    }\n}\n")),(0,r.kt)("p",null,"If you are not using TypeScript, you can use the\n",(0,r.kt)("inlineCode",{parentName:"p"},"namedMiddlewares")," object in your ",(0,r.kt)("inlineCode",{parentName:"p"},".athennarc.json")," file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "namedMiddlewares": {\n    "auth": "#app/http/middlewares/EnsureApiKeyIsValid"\n  }\n}\n')),(0,r.kt)("p",null,"Once the middleware name has been defined, you may use the\n",(0,r.kt)("inlineCode",{parentName:"p"},"Route.middleware()")," method to assign middleware to a route:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"Route.get('/welcome', () => {\n    //\n}).middleware('auth') \ud83d\udc48\n")),(0,r.kt)("h2",{id:"intercept-middleware"},"Intercept middleware"),(0,r.kt)("p",null,"Sometimes a middleware may need to do some work ",(0,r.kt)("strong",{parentName:"p"},"before"),"\nthe HTTP response has been sent to the client. For this\npurpose, you can use the Athenna interceptor middleware.\nTo create one, you can use the following command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"./node artisan make:interceptor InterceptMiddleware\n")),(0,r.kt)("p",null,"Just like ",(0,r.kt)("inlineCode",{parentName:"p"},"make:middleware"),", Athenna will auto register the\nmiddleware if using ",(0,r.kt)("inlineCode",{parentName:"p"},"make:interceptor")," command. The above\ncommand will produce the following content at\n",(0,r.kt)("inlineCode",{parentName:"p"},"app/http/interceptors/InterceptMiddleware.ts")," file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Interceptor } from '@athenna/http'\nimport type { InterceptContext, InterceptorContract } from '@athenna/http'\n\n@Interceptor()\nexport class InterceptMiddleware implements InterceptorContract {\n    public async intercept(ctx: InterceptContext): Promise<unknown> {\n      ctx.body.intercepted = true\n\n      return ctx.body\n    }\n}\n")),(0,r.kt)("admonition",{type:"warning"},(0,r.kt)("p",{parentName:"admonition"},"As you can see in the example above, you should always\nreturn the intercepted response body in interceptors.")),(0,r.kt)("p",null,"The registration process of Athenna interceptors is the\nsame of ",(0,r.kt)("a",{parentName:"p",href:"/docs/rest-api-application/middlewares#registering-middleware"},"middlewares"),"."),(0,r.kt)("p",null,"To assign your interceptor to a route, you can use the\n",(0,r.kt)("inlineCode",{parentName:"p"},"Route.interceptor()")," method:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"Route.get('/welcome', () => {\n    //\n}).interceptor('interceptMiddleware') \ud83d\udc48\n")),(0,r.kt)("h2",{id:"terminate-middleware"},"Terminate middleware"),(0,r.kt)("p",null,"Sometimes a middleware may need to do some work ",(0,r.kt)("strong",{parentName:"p"},"after"),"\nthe HTTP response has been sent to the client. For this\npurpose, you can use the Athenna interceptor middleware.\nTo create one, you can use the following command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"./node artisan make:terminator TerminateMiddleware\n")),(0,r.kt)("p",null,"Just like ",(0,r.kt)("inlineCode",{parentName:"p"},"make:middleware"),", Athenna will auto register the\nmiddleware if using ",(0,r.kt)("inlineCode",{parentName:"p"},"make:terminator")," command. The above\ncommand will produce the following content at\n",(0,r.kt)("inlineCode",{parentName:"p"},"app/http/terminators/TerminateMiddleware.ts")," file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Terminator } from '@athenna/http'\nimport type { TerminateContext, TerminatorContract } from '@athenna/http'\n\n@Terminator()\nexport class TerminateMiddleware implements TerminatorContract {\n    public async terminate(ctx: TerminateContext): Promise<void> {}\n}\n")),(0,r.kt)("p",null,"The registration process of Athenna terminators is the\nsame of ",(0,r.kt)("a",{parentName:"p",href:"/docs/rest-api-application/middlewares#registering-middleware"},"middlewares"),"."),(0,r.kt)("p",null,"To assign your terminator to a route, you can use the\n",(0,r.kt)("inlineCode",{parentName:"p"},"Route.terminator()")," method:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"Route.get('/welcome', () => {\n    //\n}).terminator('terminateMiddleware') \ud83d\udc48\n")),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"The requests log created by Athenna when the ",(0,r.kt)("inlineCode",{parentName:"p"},"logger"),"\nproperty is true in your ",(0,r.kt)("inlineCode",{parentName:"p"},"Path.config('http.ts')")," file are\nhandled by a terminator middleware! You can see the code\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/AthennaIO/Http/blob/develop/src/kernels/HttpKernel.ts#L93"},"here"),".")))}c.isMDXComponent=!0}}]);