"use strict";(self.webpackChunk_athenna_docs=self.webpackChunk_athenna_docs||[]).push([[5691],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>u});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},s=Object.keys(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var c=a.createContext({}),l=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},p=function(e){var t=l(e.components);return a.createElement(c.Provider,{value:t},e.children)},m="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,s=e.originalType,c=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),m=l(n),h=o,u=m["".concat(c,".").concat(h)]||m[h]||d[h]||s;return n?a.createElement(u,r(r({ref:t},p),{},{components:n})):a.createElement(u,r({ref:t},p))}));function u(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var s=n.length,r=new Array(s);r[0]=h;var i={};for(var c in t)hasOwnProperty.call(t,c)&&(i[c]=t[c]);i.originalType=e,i[m]="string"==typeof e?e:o,r[1]=i;for(var l=2;l<s;l++)r[l]=n[l];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},6063:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>r,default:()=>d,frontMatter:()=>s,metadata:()=>i,toc:()=>l});var a=n(7462),o=(n(7294),n(3905));const s={title:"Mocking",sidebar_position:4,description:"Understand how to mock dependencies and functions in Athenna."},r="Mocking",i={unversionedId:"testing/mocking",id:"testing/mocking",title:"Mocking",description:"Understand how to mock dependencies and functions in Athenna.",source:"@site/docs/testing/mocking.mdx",sourceDirName:"testing",slug:"/testing/mocking",permalink:"/docs/testing/mocking",draft:!1,editUrl:"https://github.com/AthennaIO/Docs/tree/main/docs/testing/mocking.mdx",tags:[],version:"current",sidebarPosition:4,frontMatter:{title:"Mocking",sidebar_position:4,description:"Understand how to mock dependencies and functions in Athenna."},sidebar:"tutorialSidebar",previous:{title:"CLI Testing",permalink:"/docs/testing/cli-tests"}},c={},l=[{value:"Introduction",id:"introduction",level:2},{value:"Mocking objects",id:"mocking-objects",level:2},{value:"Restoring mocks",id:"restoring-mocks",level:3},{value:"Spying objects",id:"spying-objects",level:3},{value:"Mocking classes",id:"mocking-classes",level:2},{value:"Mocking services",id:"mocking-services",level:3},{value:"Inversion of control",id:"inversion-of-control",level:3},{value:"Mocking facades",id:"mocking-facades",level:2},{value:"Restoring facades",id:"restoring-facades",level:3},{value:"Spying facades",id:"spying-facades",level:3},{value:"Assertions in mocks",id:"assertions-in-mocks",level:2},{value:"<code>assert.called()</code>",id:"assertcalled",level:4},{value:"<code>assert.calledOnce()</code>",id:"assertcalledonce",level:4},{value:"<code>assert.calledTimes()</code>",id:"assertcalledtimes",level:4},{value:"<code>assert.calledWith()</code>",id:"assertcalledwith",level:4},{value:"<code>assert.calledOnceWith()</code>",id:"assertcalledoncewith",level:4},{value:"<code>assert.calledTimesWith()</code>",id:"assertcalledtimeswith",level:4},{value:"<code>assert.calledWithMatch()</code>",id:"assertcalledwithmatch",level:4},{value:"<code>assert.calledBefore()</code>",id:"assertcalledbefore",level:4},{value:"<code>assert.calledAfter()</code>",id:"assertcalledafter",level:4},{value:"Mocking commands",id:"mocking-commands",level:2}],p={toc:l},m="wrapper";function d(e){let{components:t,...n}=e;return(0,o.kt)(m,(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"mocking"},"Mocking"),(0,o.kt)("p",null,"Understand how to mock dependencies and functions in Athenna."),(0,o.kt)("h2",{id:"introduction"},"Introduction"),(0,o.kt)("p",null,'When testing Athenna applications, you may wish to "mock"\ncertain aspects of your application, so they are not actually\nexecuted during a given test. For example, when testing a\ncontroller that calls a service, you may wish to mock the\nservice, so they are not actually executed during the test.\nThis allows you to only test the controller\'s HTTP response\nwithout worrying about the execution of the service since\nthe service can be tested in their own test case.'),(0,o.kt)("p",null,"This API uses ",(0,o.kt)("a",{parentName:"p",href:"https://sinonjs.org/"},"sinon")," library under\nthe hood to integrate with the Athenna ecosystem. If you need\nto create more complex mocks, we recommend you to check their\ndocumentation."),(0,o.kt)("h2",{id:"mocking-objects"},"Mocking objects"),(0,o.kt)("p",null,"The most convenient way to mock an object and change\nit behavior is by using the ",(0,o.kt)("inlineCode",{parentName:"p"},"Mock::when()")," method:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Test, Mock, type Context } from '@athenna/test'\n\nexport default class MockTest {\n  public object = {\n    foo: () => undefined\n  }\n\n  @Test()\n  public async mockAnObjectMethod({ assert }: Context) {\n    Mock.when(this.object, 'foo').return('bar') \ud83d\udc48\n\n    assert.equal(this.object.foo(), 'bar')\n  }\n}\n")),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"The ",(0,o.kt)("inlineCode",{parentName:"p"},"Mock::when()")," method is a shorthand for ",(0,o.kt)("inlineCode",{parentName:"p"},"Mock::stub()"),".\nIf you want to learn more about stubs and their API, check\n",(0,o.kt)("a",{parentName:"p",href:"https://sinonjs.org/releases/latest/stubs/"},"the stub documentation"),"\nfrom sinon.")),(0,o.kt)("p",null,"You can also use this method to throw an error when the\ngiven method is called:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"@Test()\npublic async mockAnObjectMethod({ assert }: Context) {\n  Mock.when(this.object, 'foo').throw(new Error()) \ud83d\udc48\n\n  assert.throw(() => this.object.foo(), Error)\n}\n")),(0,o.kt)("p",null,"For promises, you can use the ",(0,o.kt)("inlineCode",{parentName:"p"},"resolve()")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"reject()")," methods:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"@Test()\npublic async mockAnObjectMethod({ assert }: Context) {\n  // Resolving a promise\n  Mock.when(this.object, 'foo').resolve('bar')\n  assert.equal(await this.object.bar(), 'bar')\n\n  // Rejecting a promise\n  Mock.when(this.object, 'foo').reject(new Error())\n  await assert.rejects(() => this.object.foo(), Error)\n}\n")),(0,o.kt)("p",null,"If you don't have access to the method you are mocking, you can\nsave the return of ",(0,o.kt)("inlineCode",{parentName:"p"},"Mock::when()")," method and use it to make your\nassertions:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"@Test()\npublic async mockAnObjectMethod({ assert }: Context) {\n  const fooMock = Mock.when(this.object, 'foo').resolve('bar')\n\n  await this.someMethodThatCallsFooMethod()\n\n  assert.isTrue(fooMock.called)\n}\n")),(0,o.kt)("p",null,"To deal with more complex objects while using\n",(0,o.kt)("inlineCode",{parentName:"p"},"Mock::when()"),", you can use the ",(0,o.kt)("inlineCode",{parentName:"p"},"Mock::fake()"),"\nmethod that creates a fake method that you can\nreplace by the original one:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Test, Mock, type Context } from '@athenna/test'\n\nexport default class MockTest {\n  public object = {\n    foo: () => ({ bar: () => undefined })\n  }\n\n  @Test()\n  public async fakeAnObjectMethod({ assert }: Context) {\n    const barFake = Mock.fake()\n    Mock.when(this.object, 'foo').return({ bar: barFake }) \ud83d\udc48\n\n    this.object.foo().bar()\n\n    assert.calledOnce(barFake)\n  }\n}\n")),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"For more assertions like ",(0,o.kt)("inlineCode",{parentName:"p"},"assert.calledOnce()")," method, check the\n",(0,o.kt)("a",{parentName:"p",href:"/docs/testing/mocking#assertion-in-mocks"},"assertion in mocks"),"\ndocumentation section.")),(0,o.kt)("h3",{id:"restoring-mocks"},"Restoring mocks"),(0,o.kt)("p",null,"When you mock a method, you are changing its behavior, so\nis important to restore the default behavior of the method\nand also reset the mock history after your test finishes."),(0,o.kt)("p",null,"To do so you can use the ",(0,o.kt)("inlineCode",{parentName:"p"},"Mock::restore()")," method within\n",(0,o.kt)("inlineCode",{parentName:"p"},"@AfterEach()")," hook:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Test, Mock, AfterEach, type Context } from '@athenna/test'\n\nexport default class MockTest {\n  public object = {\n    foo: () => undefined\n  }\n\n  @AfterEach()\n  public afterEach() {\n    Mock.restore(this.object.foo) \ud83d\udc48\n  }\n\n  @Test()\n  public async mockAnObjectMethod({ assert }: Context) {\n    Mock.when(this.object, 'foo').return('bar')\n\n    assert.equal(this.object.foo(), 'bar')\n  }\n}\n")),(0,o.kt)("p",null,"Restoring each mock individually can be a tedious task, so\nto be more convenient for you, use the ",(0,o.kt)("inlineCode",{parentName:"p"},"Mock::restoreAll()"),"\nmethod to restore all everything that has been mocked using\n",(0,o.kt)("inlineCode",{parentName:"p"},"Mock")," class to default:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"@AfterEach()\npublic afterEach() {\n Mock.restoreAll()\n}\n")),(0,o.kt)("h3",{id:"spying-objects"},"Spying objects"),(0,o.kt)("p",null,"Sometimes you might need to only spy a given method\nwithout changing its behavior. For this scenario, you\ncan use the ",(0,o.kt)("inlineCode",{parentName:"p"},"Mock::spy()")," method:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Test, Mock, type Context } from '@athenna/test'\n\nexport default class MockTest {\n  public object = {\n    foo: () => 'bar'\n  }\n\n  @Test()\n  public async spyAnObjectMethod({ assert }: Context) {\n    const spy = Mock.spy(this.object, 'foo') \ud83d\udc48\n\n    assert.equal(this.object.foo(), 'bar')\n    assert.isTrue(spy.called) \ud83d\udc48\n  }\n}\n")),(0,o.kt)("p",null,"You can also spy an entire object using ",(0,o.kt)("inlineCode",{parentName:"p"},"Mock::spy()"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"@Test()\npublic async spyAnObjectMethod({ assert }: Context) {\n  Mock.spy(this.object) \ud83d\udc48\n\n  assert.equal(this.object.foo(), 'bar')\n  assert.isTrue(this.object.foo.called) \ud83d\udc48\n}\n")),(0,o.kt)("p",null,"Just like ",(0,o.kt)("inlineCode",{parentName:"p"},"Mock::when()"),", if you don't have access to the method\nyou want to spy, you can save the return of ",(0,o.kt)("inlineCode",{parentName:"p"},"Mock::spy()")," method\nand use it to make your assertions:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"@Test()\npublic async spyAnObjectMethod({ assert }: Context) {\n  Mock.spy(this.object) \ud83d\udc48\n\n  await this.someMethodThatCallsObjectFoo()\n\n  assert.calledOnce(this.object.foo) \ud83d\udc48\n}\n")),(0,o.kt)("h2",{id:"mocking-classes"},"Mocking classes"),(0,o.kt)("p",null,"Mocking classes is the same of mocking objects. But you need\nto be aware when you are mocking a class instance or all instances\nof it (",(0,o.kt)("inlineCode",{parentName:"p"},"prototype"),")."),(0,o.kt)("p",null,"Let's see how to mock a single class instance:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { ApiHelper } from '#app/helpers/ApiHelper'\nimport { Test, Mock, type Context  } from '@athenna/test'\n\nexport default class MockTest {\n  public apiHelper = new ApiHelper()\n\n  @Test()\n  public async mockAClassMethod({ assert }: Context) {\n    Mock.when(this.apiHelper, 'findOne').return({ fake: true })\n\n    assert.deepEqual(this.apiHelper.findOne(), { fake: true })\n  }\n}\n")),(0,o.kt)("p",null,"As mentioned before, with this approach, you can only mock\nthe method for the current instance. If another instance of\n",(0,o.kt)("inlineCode",{parentName:"p"},"ApiHelper")," is created, that one will not be mocked."),(0,o.kt)("p",null,"To mock a class method for all instances of a given class, you\nneed to mock the class ",(0,o.kt)("inlineCode",{parentName:"p"},"prototype"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { ApiHelper } from '#app/helpers/ApiHelper'\nimport { Test, Mock, type Context } from '@athenna/test'\n\nexport default class MockTest {\n  @Test()\n  public async mockAClassMethod({ assert }: Context) {\n    Mock.when(ApiHelper.prototype, 'findOne').return({ fake: true })\n\n    assert.deepEqual(new ApiHelper().findOne(), { fake: true })\n  }\n}\n")),(0,o.kt)("h3",{id:"mocking-services"},"Mocking services"),(0,o.kt)("p",null,"Since the default registration type of services is ",(0,o.kt)("a",{parentName:"p",href:"/docs/architecture-concepts/service-container#binding-transients"},"transient"),",\nmocking a service from the ",(0,o.kt)("a",{parentName:"p",href:"/docs/architecture-concepts/service-container"},"service container"),"\nis the same process of mocking a simple class\nusing the ",(0,o.kt)("inlineCode",{parentName:"p"},"prototype")," property:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { AppService } from '#app/services/AppService'\nimport { Test, Mock, type Context } from '@athenna/test'\n\nexport default class MockTest {\n  @Test()\n  public async mockServiceMethod({ assert }: Context) {\n    Mock.when(AppService.prototype, 'findOne').return({ fake: true }) \ud83d\udc48\n\n    assert.deepEqual(new AppService().findOne(), { fake: true })\n  }\n}\n")),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"If your service is registered as a ",(0,o.kt)("a",{parentName:"p",href:"/docs/architecture-concepts/service-container#binding-singletons"},"singleton"),"\ncheck the ",(0,o.kt)("a",{parentName:"p",href:"/docs/architecture-concepts/service-container#inversion-of-control"},"inversion of control"),"\ndocumentation section.")),(0,o.kt)("h3",{id:"inversion-of-control"},"Inversion of control"),(0,o.kt)("p",null,"Sometimes you may want to have more control over the service\ninstance; for this scenario, we recommend you to create a new instance\nof the service within your test class, registering it in the service\ncontainer and then mocking the method you want in each test case:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { AppService } from '#app/services/AppService'\nimport { BaseHttpTest } from '@athenna/core/testing/BaseHttpTest'\nimport { Test, type Context, BeforeAll, Mock } from '@athenna/test'\n\nexport default class AppControllerTest extends BaseHttpTest {\n  public appService = new AppService()\n\n  @BeforeAll()\n  public async beforeAll() {\n    ioc.instance('App/Services/AppService', this.appService) \ud83d\udc48\n  }\n\n  @Test()\n  public async mockServiceMethod({ assert, request }: Context) {\n    Mock.when(this.appService, 'findOne').return({ fake: true }) \ud83d\udc48\n\n    const response = await request.get('/api/v1')\n\n    response.assertStatusCode(200)\n    response.assertBodyContains({ fake: true })\n    assert.calledOnce(this.appService.findOne) \ud83d\udc48\n  }\n}\n")),(0,o.kt)("admonition",{type:"warning"},(0,o.kt)("p",{parentName:"admonition"},"Keep in mind that if you change your service alias in the\n",(0,o.kt)("inlineCode",{parentName:"p"},"@Service()")," annotation, you will also need to use the same\nvalue in the ",(0,o.kt)("inlineCode",{parentName:"p"},"ioc.instance()")," method."),(0,o.kt)("p",{parentName:"admonition"},"For more information, check the ",(0,o.kt)("a",{parentName:"p",href:"/docs/architecture-concepts/service-container#the-service-annotation"},(0,o.kt)("inlineCode",{parentName:"a"},"@Service()")),"\nannotation documentation section.")),(0,o.kt)("p",null,"With ",(0,o.kt)("inlineCode",{parentName:"p"},"ioc.instance()")," method, you can also create an entire different\nimplementation of your service that will be used only for testing:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"title=\"Path.fixtures('services/FakeAppService.ts')\"",title:"\"Path.fixtures('services/FakeAppService.ts')\""},"import { AppServiceInterface } from '#app/interfaces/AppServiceInterface'\n\nexport class FakeAppService implements AppServiceInterface {\n  public findOne() {\n    return { fake: true }\n  }\n}\n")),(0,o.kt)("p",null,"And now let's use it in our test class:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Test, BeforeAll, type Context } from '@athenna/test'\nimport { BaseHttpTest } from '@athenna/core/testing/BaseHttpTest'\nimport { FakeAppService } from '#tests/fixtures/services/FakeAppService'\n\nexport default class AppControllerTest extends BaseHttpTest {\n  @BeforeAll()\n  public async beforeAll() {\n    ioc.instance('App/Services/AppService', new FakeAppService()) \ud83d\udc48\n  }\n\n  @Test()\n  public async mockServiceMethod({ request }: Context) {\n    const response = await request.get('/api/v1')\n\n    response.assertStatusCode(200)\n    response.assertBodyContains({ fake: true }) \ud83d\udc48\n  }\n}\n")),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"Taste the power of dependency injection! \ud83d\ude80\ud83e\uddd9\u200d\u2642\ufe0f")),(0,o.kt)("h2",{id:"mocking-facades"},"Mocking facades"),(0,o.kt)("p",null,"When testing, you may often want to mock a call to\nan Athenna facade that occurs in your code logic.\nFor example, consider the following controller action:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Mail } from '@athenna/mail'\nimport { Controller, type Context } from '@athenna/http'\n\n@Controller()\nexport class UserController {\n  public async store({ response }: Context) {\n    const user = {\n      name: 'Antoine Du Hamel',\n      email: 'duhamelantoine1995@gmail.com'\n    }\n\n    await Mail.from('lenon@athenna.io')\n        .to(user.email)\n        .subject(`Welcome ${user.name} to Athenna!`)\n        .html('<h1>Welcome to Athenna!</h1>')\n        .send()\n\n    return response.status(200).send(user)\n  }\n}\n")),(0,o.kt)("p",null,"We can mock the call to the ",(0,o.kt)("inlineCode",{parentName:"p"},"Mail")," facade by using the\n",(0,o.kt)("inlineCode",{parentName:"p"},"when()")," method, check the example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Mail } from '@athenna/mail'\nimport { Test, type Context } from '@athenna/test'\nimport { BaseHttpTest } from '@athenna/core/testing/BaseHttpTest'\n\nexport default class AppControllerTest extends BaseHttpTest {\n  @Test()\n  public async mockMailSendMethod({ assert, request }: Context) {\n    Mail.when('send').resolve(undefined) \ud83d\udc48\n\n    const response = await request.post('/api/v1/users')\n\n    assert.calledOnce(Mail.send) \ud83d\udc48\n    response.assertStatusCode(200)\n    response.assertBodyContains([\n        // ...\n    ])\n  }\n}\n")),(0,o.kt)("h3",{id:"restoring-facades"},"Restoring facades"),(0,o.kt)("p",null,"To restore a mocked facade to it default behavior, you\ncan use the ",(0,o.kt)("inlineCode",{parentName:"p"},"restore()")," method:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"@AfterEach()\npublic afterEach() {\n  Mail.restore()\n}\n")),(0,o.kt)("admonition",{type:"warning"},(0,o.kt)("p",{parentName:"admonition"},"When mocking facades, calling ",(0,o.kt)("inlineCode",{parentName:"p"},"Mock::restoreAll()")," method\nwill restore the facade to its default behavior, but it\nwill leave the facade using the same instance for all calls. IOW,\nthe facade is converted to a ",(0,o.kt)("a",{parentName:"p",href:"/docs/architecture-concepts/service-container#binding-singleton"},"singleton"),"."),(0,o.kt)("p",{parentName:"admonition"},"This could lead to unexpected behavior in your tests, so it is recommended\nto restore each facade individually:"),(0,o.kt)("pre",{parentName:"admonition"},(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"@AfterEach()\npublic afterEach() {\n  Mail.restore()\n  Mock.restoreAll()\n}\n"))),(0,o.kt)("h3",{id:"spying-facades"},"Spying facades"),(0,o.kt)("p",null,"If you would like to spy on a facade, you may call\nthe ",(0,o.kt)("inlineCode",{parentName:"p"},"spy()")," method on the corresponding facade:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Mail } from '@athenna/mail'\nimport { Test, type Context } from '@athenna/test'\nimport { BaseHttpTest } from '@athenna/core/testing/BaseHttpTest'\n\nexport default class AppControllerTest extends BaseHttpTest {\n  @Test()\n  public async spyMailSendMethod({ assert, request }: Context) {\n    Mail.spy('send') \ud83d\udc48\n\n    const response = await request.post('/api/v1/users')\n\n    assert.calledOnce(Mail.send) \ud83d\udc48\n    response.assertStatusCode(200)\n    response.assertBodyContains([\n        // ...\n    ])\n  }\n}\n")),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"Remember that the code above will effectively try to send\nthe email since spies does not change the behavior of the\nmethod.")),(0,o.kt)("h2",{id:"assertions-in-mocks"},"Assertions in mocks"),(0,o.kt)("p",null,"Athenna's ",(0,o.kt)("inlineCode",{parentName:"p"},"assert")," helper provides a variety of extended\nassertion methods that you may utilize when testing your\nmocks:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"/docs/mocking/assertions-in-mocks#assertcalled"},(0,o.kt)("inlineCode",{parentName:"a"},"assert.called()"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"/docs/mocking/assertions-in-mocks#assertcalledonce"},(0,o.kt)("inlineCode",{parentName:"a"},"assert.calledOnce()"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"/docs/mocking/assertions-in-mocks#assertcalledtimes"},(0,o.kt)("inlineCode",{parentName:"a"},"assert.calledTimes()"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"/docs/mocking/assertions-in-mocks#assertcalledwith"},(0,o.kt)("inlineCode",{parentName:"a"},"assert.calledWith()"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"/docs/mocking/assertions-in-mocks#assertcalledoncewith"},(0,o.kt)("inlineCode",{parentName:"a"},"assert.calledOnceWith()"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"/docs/mocking/assertions-in-mocks#assertcalledtimeswith"},(0,o.kt)("inlineCode",{parentName:"a"},"assert.calledTimesWith()"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"/docs/mocking/assertions-in-mocks#assertcalledwithmatch"},(0,o.kt)("inlineCode",{parentName:"a"},"assert.calledWithMatch()"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"/docs/mocking/assertions-in-mocks#assertcalledbefore"},(0,o.kt)("inlineCode",{parentName:"a"},"assert.calledBefore()"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"/docs/mocking/assertions-in-mocks#assertcalledafter"},(0,o.kt)("inlineCode",{parentName:"a"},"assert.calledAfter()")))),(0,o.kt)("h4",{id:"assertcalled"},(0,o.kt)("inlineCode",{parentName:"h4"},"assert.called()")),(0,o.kt)("p",null,"Assert the mock was called at least once:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"assert.called(this.object.foo)\nassert.notCalled(this.object.foo)\n")),(0,o.kt)("h4",{id:"assertcalledonce"},(0,o.kt)("inlineCode",{parentName:"h4"},"assert.calledOnce()")),(0,o.kt)("p",null,"Assert the mock was called only once:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"assert.calledOnce(this.object.foo)\nassert.notCalledOnce(this.object.foo)\n")),(0,o.kt)("h4",{id:"assertcalledtimes"},(0,o.kt)("inlineCode",{parentName:"h4"},"assert.calledTimes()")),(0,o.kt)("p",null,"Assert the mock was called the given number of times:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"assert.calledTimes(this.object.foo, 1)\nassert.notCalledTimes(this.object.foo, 1)\n")),(0,o.kt)("h4",{id:"assertcalledwith"},(0,o.kt)("inlineCode",{parentName:"h4"},"assert.calledWith()")),(0,o.kt)("p",null,"Assert the mock was called with the given arguments:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"assert.calledWith(this.object.foo, 'bar')\nassert.notCalledWith(this.object.foo, 'bar')\n")),(0,o.kt)("h4",{id:"assertcalledoncewith"},(0,o.kt)("inlineCode",{parentName:"h4"},"assert.calledOnceWith()")),(0,o.kt)("p",null,"Assert the mock was called only once with the given arguments:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"assert.calledOnceWith(this.object.foo, 'bar')\nassert.notCalledOnceWith(this.object.foo, 'bar')\n")),(0,o.kt)("h4",{id:"assertcalledtimeswith"},(0,o.kt)("inlineCode",{parentName:"h4"},"assert.calledTimesWith()")),(0,o.kt)("p",null,"Assert the mock was called the given times with the given arguments:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"assert.calledTimesWith(this.object.foo, 1, 'bar')\nassert.notCalledTimesWith(this.object.foo, 1, 'bar')\n")),(0,o.kt)("h4",{id:"assertcalledwithmatch"},(0,o.kt)("inlineCode",{parentName:"h4"},"assert.calledWithMatch()")),(0,o.kt)("p",null,"Assert the mock was called with the given arguments\nmatching some of the given arguments."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"assert.calledWithMatch(this.object.foo, 'bar')\nassert.notCalledWithMatch(this.object.foo, 'bar')\n")),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"This is an alias for the following:"),(0,o.kt)("pre",{parentName:"admonition"},(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"assert.calledWith(this.object.foo, Mock.match('bar'))\n"))),(0,o.kt)("h4",{id:"assertcalledbefore"},(0,o.kt)("inlineCode",{parentName:"h4"},"assert.calledBefore()")),(0,o.kt)("p",null,"Assert the mock was called before another mock:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"assert.calledBefore(this.object.foo, this.object.bar)\nassert.notCalledBefore(this.object.foo, this.object.bar)\n")),(0,o.kt)("h4",{id:"assertcalledafter"},(0,o.kt)("inlineCode",{parentName:"h4"},"assert.calledAfter()")),(0,o.kt)("p",null,"Assert the mock was called after another mock:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"assert.calledAfter(this.object.foo, this.object.bar)\nassert.notCalledAfter(this.object.foo, this.object.bar)\n")),(0,o.kt)("h2",{id:"mocking-commands"},"Mocking commands"),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"Before checking how to mock commands, we recommend you\nto check the ",(0,o.kt)("a",{parentName:"p",href:"/docs/testing/cli-tests#changing-artisan-file-path-per-command"},"changing Artisan file path per command\ndocumentation section"),"\nto understand how you can create an isolated test case\nfor the command you wish to test.")),(0,o.kt)("p",null,"When testing commands, you may often want to mock some\nlogic that happens inside the child process that Athenna\ncreates to run your command."),(0,o.kt)("p",null,"Let's suppose we have created a command called ",(0,o.kt)("inlineCode",{parentName:"p"},"greet"),"\nwhich prompts the user his name to say hy:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"title=\"Path.commands('Greet.ts')\"",title:"\"Path.commands('Greet.ts')\""},"import { BaseCommand } from '@athenna/artisan'\n\nexport class Greet extends BaseCommand {\n  public static signature(): string {\n      return 'greet'\n  }\n\n  public async handle(): Promise<void> {\n    const name = await this.prompt.input('What is your name?')\n\n    this.logger.info(`Hello ${name}!`)\n  }\n}\n")),(0,o.kt)("p",null,"If you try to run ",(0,o.kt)("inlineCode",{parentName:"p"},"greet")," command in your tests it will\nexceed the timeout since the command will be waiting for\nthe user input name."),(0,o.kt)("p",null,"To solve this kind of situation and others, you can create\nyour own Artisan console that will first mock the ",(0,o.kt)("inlineCode",{parentName:"p"},"this.prompt.input()"),"\nmethod and then boot Artisan:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"title=\"Path.fixtures('consoles/mock-greet-input.ts')\"",title:"\"Path.fixtures('consoles/mock-greet-input.ts')\""},"import { Mock } from '@athenna/test'\nimport { Ignite } from '@athenna/core'\nimport { Prompt } from '@athenna/artisan'\n\nconst ignite = await new Ignite().load(import.meta.url, { bootLogs: false })\n\nMock.when(Prompt.prototype, 'input').resolve('Valmir Barbosa')\n\nawait ignite.console(process.argv, { displayName: 'Artisan' })\n")),(0,o.kt)("p",null,"Now, we can use this new Artisan console file to run the command\nin our test cases:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Path } from '@athenna/common'\nimport { Test, type Context } from '@athenna/test'\n\nexport default class GreetTest {\n  @Test()\n  public async testGreet({ command }: Context) {\n    const output = await command.run('greet', {\n      path: Path.fixtures('consoles/mock-greet-input.ts') \ud83d\udc48\n    })\n\n    output.assertLogged('Hello Valmir Barbosa!') \u2705\n  }\n}\n")))}d.isMDXComponent=!0}}]);