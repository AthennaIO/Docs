"use strict";(self.webpackChunk_athenna_docs=self.webpackChunk_athenna_docs||[]).push([[5312],{1953:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>i,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"testing/mocking","title":"Mocking","description":"Understand how to mock dependencies and functions in Athenna.","source":"@site/docs/testing/mocking.mdx","sourceDirName":"testing","slug":"/testing/mocking","permalink":"/docs/testing/mocking","draft":false,"unlisted":false,"editUrl":"https://github.com/AthennaIO/Docs/tree/main/docs/testing/mocking.mdx","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"title":"Mocking","sidebar_position":5,"description":"Understand how to mock dependencies and functions in Athenna."},"sidebar":"tutorialSidebar","previous":{"title":"CLI Testing","permalink":"/docs/testing/cli-tests"}}');var o=t(4848),c=t(8453);const r={title:"Mocking",sidebar_position:5,description:"Understand how to mock dependencies and functions in Athenna."},i="Mocking",a={},l=[{value:"Introduction",id:"introduction",level:2},{value:"Mocking objects",id:"mocking-objects",level:2},{value:"Mocking by arguments",id:"mocking-by-arguments",level:3},{value:"Matching by argument type",id:"matching-by-argument-type",level:3},{value:"<code>withArrayArg()</code>",id:"witharrayarg",level:4},{value:"<code>withObjectArg()</code>",id:"withobjectarg",level:4},{value:"<code>withBooleanArg()</code>",id:"withbooleanarg",level:4},{value:"<code>withFunctionArg()</code>",id:"withfunctionarg",level:4},{value:"<code>withDateArg()</code>",id:"withdatearg",level:4},{value:"<code>withRegexpArg()</code>",id:"withregexparg",level:4},{value:"<code>withFalsyArg()</code>",id:"withfalsyarg",level:4},{value:"<code>withTruthyArg()</code>",id:"withtruthyarg",level:4},{value:"Mocking by call order",id:"mocking-by-call-order",level:3},{value:"Restoring mocks",id:"restoring-mocks",level:3},{value:"Spying objects",id:"spying-objects",level:3},{value:"Mocking classes",id:"mocking-classes",level:2},{value:"Mocking services",id:"mocking-services",level:3},{value:"Inversion of control",id:"inversion-of-control",level:3},{value:"Mocking facades",id:"mocking-facades",level:2},{value:"Restoring facades",id:"restoring-facades",level:3},{value:"Spying facades",id:"spying-facades",level:3},{value:"Assertions in mocks",id:"assertions-in-mocks",level:2},{value:"<code>assert.called()</code>",id:"assertcalled",level:4},{value:"<code>assert.calledOnce()</code>",id:"assertcalledonce",level:4},{value:"<code>assert.calledTimes()</code>",id:"assertcalledtimes",level:4},{value:"<code>assert.calledWith()</code>",id:"assertcalledwith",level:4},{value:"<code>assert.calledOnceWith()</code>",id:"assertcalledoncewith",level:4},{value:"<code>assert.calledTimesWith()</code>",id:"assertcalledtimeswith",level:4},{value:"<code>assert.calledWithMatch()</code>",id:"assertcalledwithmatch",level:4},{value:"<code>assert.calledBefore()</code>",id:"assertcalledbefore",level:4},{value:"<code>assert.calledAfter()</code>",id:"assertcalledafter",level:4},{value:"Mocking commands",id:"mocking-commands",level:2},{value:"Mocking database",id:"mocking-database",level:2},{value:"Mocking the <code>find()</code> method",id:"mocking-the-find-method",level:3},{value:"Mocking the <code>create()</code> method",id:"mocking-the-create-method",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,c.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"mocking",children:"Mocking"})}),"\n",(0,o.jsx)(n.p,{children:"Understand how to mock dependencies and functions in Athenna."}),"\n",(0,o.jsx)(n.h2,{id:"introduction",children:"Introduction"}),"\n",(0,o.jsx)(n.p,{children:'When testing Athenna applications, you may wish to "mock"\ncertain aspects of your application, so they are not\nexecuted during a given test. For example, when testing a\ncontroller that calls a service, you may wish to mock the\nservice, so they are not executed during the test.\nThis allows you to only test the controller\'s HTTP response\nwithout worrying about the execution of the service since\nthe service can be tested in their own test case.'}),"\n",(0,o.jsxs)(n.p,{children:["This API uses ",(0,o.jsx)(n.a,{href:"https://sinonjs.org/",children:"sinon"})," library under\nthe hood to integrate with the Athenna ecosystem. If you need\nto create more specific mocks, we recommend you to check their\ndocumentation."]}),"\n",(0,o.jsx)(n.h2,{id:"mocking-objects",children:"Mocking objects"}),"\n",(0,o.jsxs)(n.p,{children:["The most convenient way to mock an object and change\nit behavior is by using the ",(0,o.jsx)(n.code,{children:"Mock::when()"})," method:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { Test, Mock, type Context } from '@athenna/test'\n\nexport default class MockTest {\n  public object = {\n    foo: () => undefined\n  }\n\n  @Test()\n  public async mockAnObjectMethod({ assert }: Context) {\n    Mock.when(this.object, 'foo').return('bar') \ud83d\udc48\n\n    assert.equal(this.object.foo(), 'bar')\n  }\n}\n"})}),"\n",(0,o.jsx)(n.admonition,{type:"tip",children:(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.code,{children:"Mock::when()"})," method is a shorthand for ",(0,o.jsx)(n.code,{children:"Mock::stub()"}),".\nIf you want to learn more about stubs and their API, check\n",(0,o.jsx)(n.a,{href:"https://sinonjs.org/releases/latest/stubs/",children:"the stub documentation"}),"\nfrom sinon."]})}),"\n",(0,o.jsx)(n.p,{children:"You can also use this method to throw an error when the\ngiven method is called:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"@Test()\npublic async mockAnObjectMethod({ assert }: Context) {\n  Mock.when(this.object, 'foo').throw(new Error()) \ud83d\udc48\n\n  assert.throw(() => this.object.foo(), Error)\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["For promises, you can use the ",(0,o.jsx)(n.code,{children:"resolve()"})," or ",(0,o.jsx)(n.code,{children:"reject()"})," methods:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"@Test()\npublic async mockAnObjectMethod({ assert }: Context) {\n  // Resolving a promise\n  Mock.when(this.object, 'foo').resolve('bar')\n  assert.equal(await this.object.bar(), 'bar')\n\n  // Rejecting a promise\n  Mock.when(this.object, 'foo').reject(new Error())\n  await assert.rejects(() => this.object.foo(), Error)\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["If you don't have access to the method you are mocking, or you want\nto create a specific kind of mock, you can get the stub created with\nthe ",(0,o.jsx)(n.code,{children:"get()"})," method:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"@Test()\npublic async mockAnObjectMethod({ assert }: Context) {\n  const fooMock = Mock.when(this.object, 'foo').resolve('bar').get()\n\n  await this.someMethodThatCallsFooMethod()\n\n  assert.isTrue(fooMock.called)\n}\n\n// Or\n\n@Test()\npublic async mockAnObjectMethod({ assert }: Context) {\n  const fooMock = Mock.when(this.object, 'foo').get()\n\n  fooMock.returns('bar')\n\n  await this.someMethodThatCallsFooMethod()\n\n  assert.isTrue(fooMock.called)\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["To deal with more complex objects while using\n",(0,o.jsx)(n.code,{children:"Mock::when()"}),", you can use the ",(0,o.jsx)(n.code,{children:"Mock::fake()"}),"\nmethod that creates a fake method that you can\nreplace by the original one:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { Test, Mock, type Context } from '@athenna/test'\n\nexport default class MockTest {\n  public object = {\n    foo: () => ({ bar: () => undefined })\n  }\n\n  @Test()\n  public async fakeAnObjectMethod({ assert }: Context) {\n    const barFake = Mock.fake()\n    Mock.when(this.object, 'foo').return({ bar: barFake }) \ud83d\udc48\n\n    this.object.foo().bar()\n\n    assert.calledOnce(barFake)\n  }\n}\n"})}),"\n",(0,o.jsx)(n.admonition,{type:"tip",children:(0,o.jsxs)(n.p,{children:["For more assertions like ",(0,o.jsx)(n.code,{children:"assert.calledOnce()"})," method, check the\n",(0,o.jsx)(n.a,{href:"/docs/testing/mocking#assertion-in-mocks",children:"assertion in mocks"}),"\ndocumentation section."]})}),"\n",(0,o.jsx)(n.h3,{id:"mocking-by-arguments",children:"Mocking by arguments"}),"\n",(0,o.jsxs)(n.p,{children:["If your method receives an argument, you might need to test\ndifferent scenarios based on the argument it has received.\nAthenna makes it delicious to mock this kind of situation\nusing the ",(0,o.jsx)(n.code,{children:"withArgs()"})," method:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { Test, Mock, type Context } from '@athenna/test'\n\nexport default class MockTest {\n  public object = {\n    foo: (arg?: any) => 'Im the original!'\n  }\n\n  @Test()\n  public async mockAnObjectMethodByArgument({ assert }: Context) {\n    Mock.when(this.object, 'foo')\n      .withArgs('1') \ud83d\udc48\n      .return('mocked!')\n      .withArgs('2') \ud83d\udc48\n      .return('mocked!!')\n\n    assert.equal(this.object.foo('1'), 'mocked!')\n    assert.equal(this.object.foo('2'), 'mocked!!')\n\n    assert.equal(this.object.foo(), 'Im the original!')\n    assert.equal(this.object.foo('3'), 'Im the original!')\n  }\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["As you can see in the example above, when the arguments set for\nthe ",(0,o.jsx)(n.code,{children:"foo()"})," method don't match the defined mocks, the real\nimplementation of ",(0,o.jsx)(n.code,{children:"foo()"})," will be the chosen one, which can\nbe a beneficial behavior for certain scenarios."]}),"\n",(0,o.jsx)(n.p,{children:'If you wish to remove this behavior, you could add the\n"default" return before adding the arguments mocks:'}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"@Test()\npublic async mockAnObjectMethodByArgument({ assert }: Context) {\n  Mock.when(this.object, 'foo')\n    .return('default mock') \ud83d\udc48\n    .withArgs('1')\n    .return('mocked!')\n    .withArgs('2')\n    .return('mocked!!')\n\n  assert.equal(this.object.foo('1'), 'mocked!')\n  assert.equal(this.object.foo('2'), 'mocked!!')\n\n  assert.equal(this.object.foo(), 'default mock')\n  assert.equal(this.object.foo('3'), 'default mock')\n}\n"})}),"\n",(0,o.jsx)(n.h3,{id:"matching-by-argument-type",children:"Matching by argument type"}),"\n",(0,o.jsxs)(n.p,{children:["Sometimes you don't mind what is the value of the argument\nthat you will receive, but only the type of it, for this\nkind of situation you can use methods like ",(0,o.jsx)(n.code,{children:"withStringArg()"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"@Test()\npublic async mockAnObjectMethodByArgumentType({ assert }: Context) {\n  Mock.when(this.object, 'foo')\n    .withStringArg() \ud83d\udc48\n    .return('mocked!')\n    .withNumberArg() \ud83d\udc48\n    .return('mocked!!')\n\n  assert.equal(this.object.foo(1), 'mocked!!')\n  assert.equal(this.object.foo('1'), 'mocked!')\n}\n"})}),"\n",(0,o.jsx)(n.p,{children:"The code above is basically an alias for the following:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"@Test()\npublic async mockAnObjectMethodByArgumentType({ assert }: Context) {\n  Mock.when(this.object, 'foo')\n    .withArgs(Mock.match.string) \ud83d\udc48\n    .return('mocked!')\n    .withArgs(Mock.match.number) \ud83d\udc48\n    .return('mocked!!')\n\n  assert.equal(this.object.foo(1), 'mocked!!')\n  assert.equal(this.object.foo('1'), 'mocked!')\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["This means that you can use the ",(0,o.jsx)(n.code,{children:"Mock.match"})," helper to match more\ncomplex kind of data in your arguments:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"@Test()\npublic async mockAnObjectMethodByArgumentType({ assert }: Context) {\n  Mock.when(this.object, 'foo')\n    .withArgs(Mock.match({ id: 1 })) \ud83d\udc48\n    .return('mocked!')\n    .withArgs(Mock.match({ id: 2 })) \ud83d\udc48\n    .return('mocked!!')\n\n  const user1 = { id: 1, createdAt: new Date() }\n  const user2 = { id: 2, createdAt: new Date() }\n\n  assert.equal(this.object.foo(user1), 'mocked!')\n  assert.equal(this.object.foo(user2), 'mocked!!')\n\n  // Not a mocked scenario, returning the real implementation.\n  assert.equal(this.object.foo({ id: 3 }), 'Im the original!')\n}\n"})}),"\n",(0,o.jsx)(n.p,{children:"Here you can check other methods that could help you to mock your\nmethods by the argument value:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"/docs/testing/mocking#witharrayarg",children:(0,o.jsx)(n.code,{children:"withArrayArg()"})})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"/docs/testing/mocking#withobjectarg",children:(0,o.jsx)(n.code,{children:"withObjectArg()"})})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"/docs/testing/mocking#withbooleanarg",children:(0,o.jsx)(n.code,{children:"withBooleanArg()"})})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"/docs/testing/mocking#withfunctionarg",children:(0,o.jsx)(n.code,{children:"withFunctionArg()"})})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"/docs/testing/mocking#withdatearg",children:(0,o.jsx)(n.code,{children:"withDateArg()"})})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"/docs/testing/mocking#withregexparg",children:(0,o.jsx)(n.code,{children:"withRegexpArg()"})})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"/docs/testing/mocking#withfalsyarg",children:(0,o.jsx)(n.code,{children:"withFalsyArg()"})})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"/docs/testing/mocking#withtruthyarg",children:(0,o.jsx)(n.code,{children:"withTruthyArg()"})})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"/docs/testing/mocking#withanyarg",children:(0,o.jsx)(n.code,{children:"withAnyArg()"})})}),"\n"]}),"\n",(0,o.jsx)(n.h4,{id:"witharrayarg",children:(0,o.jsx)(n.code,{children:"withArrayArg()"})}),"\n",(0,o.jsx)(n.p,{children:"Set up a mock when mocked method is called with an array:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"Mock.when(this.object, 'foo').withArrayArg().return('bar')\n\nthis.object.foo([])\n"})}),"\n",(0,o.jsx)(n.h4,{id:"withobjectarg",children:(0,o.jsx)(n.code,{children:"withObjectArg()"})}),"\n",(0,o.jsx)(n.p,{children:"Set up a mock when mocked method is called with an object:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"Mock.when(this.object, 'foo').withObjectArg().return('bar')\n\nthis.object.foo({})\n"})}),"\n",(0,o.jsx)(n.h4,{id:"withbooleanarg",children:(0,o.jsx)(n.code,{children:"withBooleanArg()"})}),"\n",(0,o.jsx)(n.p,{children:"Set up a mock when mocked method is called with a boolean:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"Mock.when(this.object, 'foo').withBooleanArg().return('bar')\n\nthis.object.foo(true)\nthis.object.foo(false)\n"})}),"\n",(0,o.jsx)(n.h4,{id:"withfunctionarg",children:(0,o.jsx)(n.code,{children:"withFunctionArg()"})}),"\n",(0,o.jsx)(n.p,{children:"Set up a mock when mocked method is called with a function:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"Mock.when(this.object, 'foo').withFunctionArg().return('bar')\n\nthis.object.foo(() => {})\n"})}),"\n",(0,o.jsx)(n.h4,{id:"withdatearg",children:(0,o.jsx)(n.code,{children:"withDateArg()"})}),"\n",(0,o.jsx)(n.p,{children:"Set up a mock when mocked method is called with a date:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"Mock.when(this.object, 'foo').withDateArg().return('bar')\n\nthis.object.foo(new Date())\n"})}),"\n",(0,o.jsx)(n.h4,{id:"withregexparg",children:(0,o.jsx)(n.code,{children:"withRegexpArg()"})}),"\n",(0,o.jsx)(n.p,{children:"Set up a mock when mocked method is called with a regexp:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"Mock.when(this.object, 'foo').withRegexpArg().return('bar')\n\nthis.object.foo(new RegExp())\n"})}),"\n",(0,o.jsx)(n.h4,{id:"withfalsyarg",children:(0,o.jsx)(n.code,{children:"withFalsyArg()"})}),"\n",(0,o.jsx)(n.p,{children:"Set up a mock when mocked method is called with a falsy value:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"Mock.when(this.object, 'foo').withFalsyArg().return('bar')\n\nthis.object.foo('')\nthis.object.foo(false)\n"})}),"\n",(0,o.jsx)(n.h4,{id:"withtruthyarg",children:(0,o.jsx)(n.code,{children:"withTruthyArg()"})}),"\n",(0,o.jsx)(n.p,{children:"Set up a mock when mocked method is called with a truthy value:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"Mock.when(this.object, 'foo').withTruthyArg().return('bar')\n\nthis.object.foo('hey')\nthis.object.foo(true)\n"})}),"\n",(0,o.jsx)(n.h3,{id:"mocking-by-call-order",children:"Mocking by call order"}),"\n",(0,o.jsxs)(n.p,{children:["It's possible to mock a method only for a specific call count, for example, I might\nneed to mock my method on the first and second call, but on the third one, I\nwant the original method result. To do so you can use methods like ",(0,o.jsx)(n.code,{children:"onCall()"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"@Test()\npublic async mockAnObjectMethodByCall({ assert }: Context) {\n  Mock.when(this.object, 'foo')\n    .onCall(1) \ud83d\udc48\n    .return('mocked!')\n    .onCall(2) \ud83d\udc48\n    .return('mocked!!')\n\n  assert.equal(this.object.foo(), 'mocked!')\n  assert.equal(this.object.foo(), 'mocked!!')\n\n  // Not a mocked scenario, returning the real implementation.\n  assert.equal(this.object.foo(), 'Im the original!')\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["For convenience, you can use the ",(0,o.jsx)(n.code,{children:"onFirstCall()"}),", ",(0,o.jsx)(n.code,{children:"onSecondCall()"})," or the\n",(0,o.jsx)(n.code,{children:"onThirdCall()"})," methods also:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"@Test()\npublic async mockAnObjectMethodByCall({ assert }: Context) {\n  Mock.when(this.object, 'foo')\n    .onFirstCall() \ud83d\udc48\n    .return('mocked!')\n    .onSecondCall() \ud83d\udc48\n    .return('mocked!!')\n    .onThirdCall() \ud83d\udc48\n    .return('mocked!!!')\n\n  assert.equal(this.object.foo(), 'mocked!')\n  assert.equal(this.object.foo(), 'mocked!!')\n  assert.equal(this.object.foo(), 'mocked!!!')\n\n  // Not a mocked scenario, returning the real implementation.\n  assert.equal(this.object.foo(), 'Im the original!')\n}\n"})}),"\n",(0,o.jsxs)(n.admonition,{type:"tip",children:[(0,o.jsxs)(n.p,{children:["You can also merge ",(0,o.jsx)(n.code,{children:"onCall()"})," with ",(0,o.jsx)(n.code,{children:"withArgs()"})," to craft mocks that will be called\nnth times with determined argument:"]}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"@Test()\npublic async mockAnObjectMethodByCall({ assert }: Context) {\n  Mock.when(this.object, 'foo')\n    .withArgs(1)\n    .onFirstCall()\n    .return('mocked!')\n    .onSecondCall()\n    .return('mocked!!')\n\n  assert.equal(this.object.foo(1), 'mocked!')\n  assert.equal(this.object.foo(1), 'mocked!!')\n\n  // Not a mocked scenario, returning the real implementation.\n  assert.equal(this.object.foo(1), 'Im the original!')\n}\n"})})]}),"\n",(0,o.jsx)(n.h3,{id:"restoring-mocks",children:"Restoring mocks"}),"\n",(0,o.jsx)(n.p,{children:"When you mock a method, you are changing its behavior, so it\nis important to restore the default behavior of the method\nand also reset the mock history after your test finishes."}),"\n",(0,o.jsxs)(n.p,{children:["To do so you can use the ",(0,o.jsx)(n.code,{children:"Mock::restore()"})," method within\n",(0,o.jsx)(n.code,{children:"@AfterEach()"})," hook:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { Test, Mock, AfterEach, type Context } from '@athenna/test'\n\nexport default class MockTest {\n  public object = {\n    foo: () => undefined\n  }\n\n  @AfterEach()\n  public afterEach() {\n    Mock.restore(this.object.foo) \ud83d\udc48\n  }\n\n  @Test()\n  public async mockAnObjectMethod({ assert }: Context) {\n    Mock.when(this.object, 'foo').return('bar')\n\n    assert.equal(this.object.foo(), 'bar')\n  }\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Restoring each mock individually can be a tedious task, so\nto be more convenient for you, use the ",(0,o.jsx)(n.code,{children:"Mock::restoreAll()"}),"\nmethod to restore all everything that has been mocked using\n",(0,o.jsx)(n.code,{children:"Mock"})," class to default:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"@AfterEach()\npublic afterEach() {\n Mock.restoreAll()\n}\n"})}),"\n",(0,o.jsx)(n.h3,{id:"spying-objects",children:"Spying objects"}),"\n",(0,o.jsxs)(n.p,{children:["Sometimes you might need to only spy a given method\nwithout changing its behavior. For this scenario, you\ncan use the ",(0,o.jsx)(n.code,{children:"Mock::spy()"})," method:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { Test, Mock, type Context } from '@athenna/test'\n\nexport default class MockTest {\n  public object = {\n    foo: () => 'bar'\n  }\n\n  @Test()\n  public async spyAnObjectMethod({ assert }: Context) {\n    const spy = Mock.spy(this.object, 'foo') \ud83d\udc48\n\n    assert.equal(this.object.foo(), 'bar')\n    assert.isTrue(spy.called) \ud83d\udc48\n  }\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["You can also spy an entire object using ",(0,o.jsx)(n.code,{children:"Mock::spy()"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"@Test()\npublic async spyAnObjectMethod({ assert }: Context) {\n  Mock.spy(this.object) \ud83d\udc48\n\n  assert.equal(this.object.foo(), 'bar')\n  assert.isTrue(this.object.foo.called) \ud83d\udc48\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Just like ",(0,o.jsx)(n.code,{children:"Mock::when()"}),", if you don't have access to the method\nyou want to spy, you can save the return of ",(0,o.jsx)(n.code,{children:"Mock::spy()"})," method\nand use it to make your assertions:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"@Test()\npublic async spyAnObjectMethod({ assert }: Context) {\n  Mock.spy(this.object) \ud83d\udc48\n\n  await this.someMethodThatCallsObjectFoo()\n\n  assert.calledOnce(this.object.foo) \ud83d\udc48\n}\n"})}),"\n",(0,o.jsx)(n.h2,{id:"mocking-classes",children:"Mocking classes"}),"\n",(0,o.jsxs)(n.p,{children:["Mocking classes is the same of mocking objects. But you need\nto be aware when you are mocking a class instance or all instances\nof it (",(0,o.jsx)(n.code,{children:"prototype"}),")."]}),"\n",(0,o.jsx)(n.p,{children:"Let's see how to mock a single class instance:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { ApiHelper } from '#src/helpers/ApiHelper'\nimport { Test, Mock, type Context  } from '@athenna/test'\n\nexport default class MockTest {\n  public apiHelper = new ApiHelper()\n\n  @Test()\n  public async mockAClassMethod({ assert }: Context) {\n    Mock.when(this.apiHelper, 'findOne').return({ fake: true })\n\n    assert.deepEqual(this.apiHelper.findOne(), { fake: true })\n  }\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["As mentioned before, with this approach, you can only mock\nthe method for the current instance. If another instance of\n",(0,o.jsx)(n.code,{children:"ApiHelper"})," is created, that one will not be mocked."]}),"\n",(0,o.jsxs)(n.p,{children:["To mock a class method for all instances of a given class, you\nneed to mock the class ",(0,o.jsx)(n.code,{children:"prototype"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { ApiHelper } from '#src/helpers/ApiHelper'\nimport { Test, Mock, type Context } from '@athenna/test'\n\nexport default class MockTest {\n  @Test()\n  public async mockAClassMethod({ assert }: Context) {\n    Mock.when(ApiHelper.prototype, 'findOne').return({ fake: true })\n\n    assert.deepEqual(new ApiHelper().findOne(), { fake: true })\n  }\n}\n"})}),"\n",(0,o.jsx)(n.h3,{id:"mocking-services",children:"Mocking services"}),"\n",(0,o.jsxs)(n.p,{children:["Since the default registration type of services is ",(0,o.jsx)(n.a,{href:"/docs/architecture-concepts/service-container#binding-transients",children:"transient"}),",\nmocking a service from the ",(0,o.jsx)(n.a,{href:"/docs/architecture-concepts/service-container",children:"service container"}),"\nis the same process of mocking a simple class\nusing the ",(0,o.jsx)(n.code,{children:"prototype"})," property:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { AppService } from '#src/services/AppService'\nimport { Test, Mock, type Context } from '@athenna/test'\n\nexport default class MockTest {\n  @Test()\n  public async mockServiceMethod({ assert }: Context) {\n    Mock.when(AppService.prototype, 'findOne').return({ fake: true }) \ud83d\udc48\n\n    assert.deepEqual(new AppService().findOne(), { fake: true })\n  }\n}\n"})}),"\n",(0,o.jsx)(n.admonition,{type:"tip",children:(0,o.jsxs)(n.p,{children:["If your service is registered as a ",(0,o.jsx)(n.a,{href:"/docs/architecture-concepts/service-container#binding-singletons",children:"singleton"}),"\ncheck the ",(0,o.jsx)(n.a,{href:"/docs/architecture-concepts/service-container#inversion-of-control",children:"inversion of control"}),"\ndocumentation section."]})}),"\n",(0,o.jsx)(n.h3,{id:"inversion-of-control",children:"Inversion of control"}),"\n",(0,o.jsx)(n.p,{children:"Sometimes you may want to have more control over the service\ninstance; for this scenario, we recommend you to create a new instance\nof the service within your test class, registering it in the service\ncontainer and then mocking the method you want in each test case:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { AppService } from '#src/services/AppService'\nimport { BaseHttpTest } from '@athenna/core/testing/BaseHttpTest'\nimport { Test, type Context, BeforeAll, Mock } from '@athenna/test'\n\nexport default class AppControllerTest extends BaseHttpTest {\n  public appService = new AppService()\n\n  @BeforeAll()\n  public async beforeAll() {\n    ioc.instance('App/Services/AppService', this.appService) \ud83d\udc48\n  }\n\n  @Test()\n  public async mockServiceMethod({ assert, request }: Context) {\n    Mock.when(this.appService, 'findOne').return({ fake: true }) \ud83d\udc48\n\n    const response = await request.get('/api/v1')\n\n    response.assertStatusCode(200)\n    response.assertBodyContains({ fake: true })\n    assert.calledOnce(this.appService.findOne) \ud83d\udc48\n  }\n}\n"})}),"\n",(0,o.jsxs)(n.admonition,{type:"warning",children:[(0,o.jsxs)(n.p,{children:["Keep in mind that if you change your service alias in the\n",(0,o.jsx)(n.code,{children:"@Service()"})," annotation, you will also need to use the same\nvalue in the ",(0,o.jsx)(n.code,{children:"ioc.instance()"})," method."]}),(0,o.jsxs)(n.p,{children:["For more information, check the ",(0,o.jsx)(n.a,{href:"/docs/architecture-concepts/service-container#the-service-annotation",children:(0,o.jsx)(n.code,{children:"@Service()"})}),"\nannotation documentation section."]})]}),"\n",(0,o.jsxs)(n.p,{children:["With ",(0,o.jsx)(n.code,{children:"ioc.instance()"})," method, you can also create an entire different\nimplementation of your service that will be used only for testing:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",metastring:"title=\"Path.fixtures('services/FakeAppService.ts')\"",children:"import { AppServiceInterface } from '#src/interfaces/AppServiceInterface'\n\nexport class FakeAppService implements AppServiceInterface {\n  public findOne() {\n    return { fake: true }\n  }\n}\n"})}),"\n",(0,o.jsx)(n.p,{children:"And now let's use it in our test class:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { Test, BeforeAll, type Context } from '@athenna/test'\nimport { BaseHttpTest } from '@athenna/core/testing/BaseHttpTest'\nimport { FakeAppService } from '#tests/fixtures/services/FakeAppService'\n\nexport default class AppControllerTest extends BaseHttpTest {\n  @BeforeAll()\n  public async beforeAll() {\n    ioc.instance('App/Services/AppService', new FakeAppService()) \ud83d\udc48\n  }\n\n  @Test()\n  public async mockServiceMethod({ request }: Context) {\n    const response = await request.get('/api/v1')\n\n    response.assertStatusCode(200)\n    response.assertBodyContains({ fake: true }) \ud83d\udc48\n  }\n}\n"})}),"\n",(0,o.jsx)(n.admonition,{type:"tip",children:(0,o.jsx)(n.p,{children:"Taste the power of dependency injection! \ud83d\ude80\ud83e\uddd9\u200d\u2642\ufe0f"})}),"\n",(0,o.jsx)(n.h2,{id:"mocking-facades",children:"Mocking facades"}),"\n",(0,o.jsx)(n.p,{children:"When testing, you may often want to mock a call to\nan Athenna facade that occurs in your code logic.\nFor example, consider the following controller action:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { Mail } from '@athenna/mail'\nimport { Controller, type Context } from '@athenna/http'\n\n@Controller()\nexport class UserController {\n  public async store({ response }: Context) {\n    const user = {\n      name: 'Antoine Du Hamel',\n      email: 'duhamelantoine1995@gmail.com'\n    }\n\n    await Mail.from('lenon@athenna.io')\n        .to(user.email)\n        .subject(`Welcome ${user.name} to Athenna!`)\n        .html('<h1>Welcome to Athenna!</h1>')\n        .send()\n\n    return response.status(200).send(user)\n  }\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["We can mock the call to the ",(0,o.jsx)(n.code,{children:"Mail"})," facade by using the\n",(0,o.jsx)(n.code,{children:"when()"})," method, check the example:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { Mail } from '@athenna/mail'\nimport { Test, type Context } from '@athenna/test'\nimport { BaseHttpTest } from '@athenna/core/testing/BaseHttpTest'\n\nexport default class AppControllerTest extends BaseHttpTest {\n  @Test()\n  public async mockMailSendMethod({ assert, request }: Context) {\n    Mail.when('send').resolve(undefined) \ud83d\udc48\n\n    const response = await request.post('/api/v1/users')\n\n    assert.calledOnce(Mail.send) \ud83d\udc48\n    response.assertStatusCode(200)\n    response.assertBodyContains([\n        // ...\n    ])\n  }\n}\n"})}),"\n",(0,o.jsxs)(n.admonition,{type:"tip",children:[(0,o.jsxs)(n.p,{children:["Just like in ",(0,o.jsx)(n.code,{children:"Mock::when()"})," method, you are able to mock by arguments\nand by calls using the Facade's ",(0,o.jsx)(n.code,{children:"when()"})," method:"]}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"Mail.when('to')\n    .withArgs('lenon@athenna.io')\n    .throw(new Error())\n"})})]}),"\n",(0,o.jsx)(n.h3,{id:"restoring-facades",children:"Restoring facades"}),"\n",(0,o.jsxs)(n.p,{children:["To restore a mocked facade to it default behavior, you\ncan use the ",(0,o.jsx)(n.code,{children:"restore()"})," method:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"@AfterEach()\npublic afterEach() {\n  Mail.restore()\n}\n"})}),"\n",(0,o.jsxs)(n.admonition,{type:"warning",children:[(0,o.jsxs)(n.p,{children:["When mocking facades, calling ",(0,o.jsx)(n.code,{children:"Mock::restoreAll()"})," method\nwill restore the facade to its default behavior, but it\nwill leave the facade using the same instance for all calls. IOW,\nthe facade is converted to a ",(0,o.jsx)(n.a,{href:"/docs/architecture-concepts/service-container#binding-singleton",children:"singleton"}),"."]}),(0,o.jsx)(n.p,{children:"This could lead to unexpected behavior in your tests, so it is recommended\nto restore each facade individually:"}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"@AfterEach()\npublic afterEach() {\n  Mail.restore()\n  Mock.restoreAll()\n}\n"})})]}),"\n",(0,o.jsx)(n.h3,{id:"spying-facades",children:"Spying facades"}),"\n",(0,o.jsxs)(n.p,{children:["If you would like to spy on a facade, you may call\nthe ",(0,o.jsx)(n.code,{children:"spy()"})," method on the corresponding facade:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { Mail } from '@athenna/mail'\nimport { Test, type Context } from '@athenna/test'\nimport { BaseHttpTest } from '@athenna/core/testing/BaseHttpTest'\n\nexport default class AppControllerTest extends BaseHttpTest {\n  @Test()\n  public async spyMailSendMethod({ assert, request }: Context) {\n    Mail.spy('send') \ud83d\udc48\n\n    const response = await request.post('/api/v1/users')\n\n    assert.calledOnce(Mail.send) \ud83d\udc48\n    response.assertStatusCode(200)\n    response.assertBodyContains([\n        // ...\n    ])\n  }\n}\n"})}),"\n",(0,o.jsx)(n.admonition,{type:"note",children:(0,o.jsx)(n.p,{children:"Remember that the code above will effectively try to send\nthe email since spies does not change the behavior of the\nmethod."})}),"\n",(0,o.jsx)(n.h2,{id:"assertions-in-mocks",children:"Assertions in mocks"}),"\n",(0,o.jsxs)(n.p,{children:["Athenna's ",(0,o.jsx)(n.code,{children:"assert"})," helper provides a variety of extended\nassertion methods that you may utilize when testing your\nmocks:"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"/docs/mocking/assertions-in-mocks#assertcalled",children:(0,o.jsx)(n.code,{children:"assert.called()"})})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"/docs/mocking/assertions-in-mocks#assertcalledonce",children:(0,o.jsx)(n.code,{children:"assert.calledOnce()"})})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"/docs/mocking/assertions-in-mocks#assertcalledtimes",children:(0,o.jsx)(n.code,{children:"assert.calledTimes()"})})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"/docs/mocking/assertions-in-mocks#assertcalledwith",children:(0,o.jsx)(n.code,{children:"assert.calledWith()"})})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"/docs/mocking/assertions-in-mocks#assertcalledoncewith",children:(0,o.jsx)(n.code,{children:"assert.calledOnceWith()"})})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"/docs/mocking/assertions-in-mocks#assertcalledtimeswith",children:(0,o.jsx)(n.code,{children:"assert.calledTimesWith()"})})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"/docs/mocking/assertions-in-mocks#assertcalledwithmatch",children:(0,o.jsx)(n.code,{children:"assert.calledWithMatch()"})})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"/docs/mocking/assertions-in-mocks#assertcalledbefore",children:(0,o.jsx)(n.code,{children:"assert.calledBefore()"})})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"/docs/mocking/assertions-in-mocks#assertcalledafter",children:(0,o.jsx)(n.code,{children:"assert.calledAfter()"})})}),"\n"]}),"\n",(0,o.jsx)(n.h4,{id:"assertcalled",children:(0,o.jsx)(n.code,{children:"assert.called()"})}),"\n",(0,o.jsx)(n.p,{children:"Assert the mock was called at least once:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"assert.called(this.object.foo)\nassert.notCalled(this.object.foo)\n"})}),"\n",(0,o.jsx)(n.h4,{id:"assertcalledonce",children:(0,o.jsx)(n.code,{children:"assert.calledOnce()"})}),"\n",(0,o.jsx)(n.p,{children:"Assert the mock was called only once:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"assert.calledOnce(this.object.foo)\nassert.notCalledOnce(this.object.foo)\n"})}),"\n",(0,o.jsx)(n.h4,{id:"assertcalledtimes",children:(0,o.jsx)(n.code,{children:"assert.calledTimes()"})}),"\n",(0,o.jsx)(n.p,{children:"Assert the mock was called the given number of times:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"assert.calledTimes(this.object.foo, 1)\nassert.notCalledTimes(this.object.foo, 1)\n"})}),"\n",(0,o.jsx)(n.h4,{id:"assertcalledwith",children:(0,o.jsx)(n.code,{children:"assert.calledWith()"})}),"\n",(0,o.jsx)(n.p,{children:"Assert the mock was called with the given arguments:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"assert.calledWith(this.object.foo, 'bar')\nassert.notCalledWith(this.object.foo, 'bar')\n"})}),"\n",(0,o.jsx)(n.h4,{id:"assertcalledoncewith",children:(0,o.jsx)(n.code,{children:"assert.calledOnceWith()"})}),"\n",(0,o.jsx)(n.p,{children:"Assert the mock was called only once with the given arguments:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"assert.calledOnceWith(this.object.foo, 'bar')\nassert.notCalledOnceWith(this.object.foo, 'bar')\n"})}),"\n",(0,o.jsx)(n.h4,{id:"assertcalledtimeswith",children:(0,o.jsx)(n.code,{children:"assert.calledTimesWith()"})}),"\n",(0,o.jsx)(n.p,{children:"Assert the mock was called the given times with the given arguments:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"assert.calledTimesWith(this.object.foo, 1, 'bar')\nassert.notCalledTimesWith(this.object.foo, 1, 'bar')\n"})}),"\n",(0,o.jsx)(n.h4,{id:"assertcalledwithmatch",children:(0,o.jsx)(n.code,{children:"assert.calledWithMatch()"})}),"\n",(0,o.jsx)(n.p,{children:"Assert the mock was called with the given arguments\nmatching some of the given arguments."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"assert.calledWithMatch(this.object.foo, 'bar')\nassert.notCalledWithMatch(this.object.foo, 'bar')\n"})}),"\n",(0,o.jsxs)(n.admonition,{type:"tip",children:[(0,o.jsx)(n.p,{children:"This is an alias for the following:"}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"assert.calledWith(this.object.foo, Mock.match('bar'))\n"})})]}),"\n",(0,o.jsx)(n.h4,{id:"assertcalledbefore",children:(0,o.jsx)(n.code,{children:"assert.calledBefore()"})}),"\n",(0,o.jsx)(n.p,{children:"Assert the mock was called before another mock:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"assert.calledBefore(this.object.foo, this.object.bar)\nassert.notCalledBefore(this.object.foo, this.object.bar)\n"})}),"\n",(0,o.jsx)(n.h4,{id:"assertcalledafter",children:(0,o.jsx)(n.code,{children:"assert.calledAfter()"})}),"\n",(0,o.jsx)(n.p,{children:"Assert the mock was called after another mock:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"assert.calledAfter(this.object.foo, this.object.bar)\nassert.notCalledAfter(this.object.foo, this.object.bar)\n"})}),"\n",(0,o.jsx)(n.h2,{id:"mocking-commands",children:"Mocking commands"}),"\n",(0,o.jsx)(n.admonition,{type:"note",children:(0,o.jsxs)(n.p,{children:["Before checking how to mock commands, we recommend you\nto check the ",(0,o.jsx)(n.a,{href:"/docs/testing/cli-tests#changing-artisan-file-path-per-command",children:"changing Artisan file path per command\ndocumentation section"}),"\nto understand how you can create an isolated test case\nfor the command you wish to test."]})}),"\n",(0,o.jsx)(n.p,{children:"When testing commands, you may often want to mock some\nlogic that happens inside the child process that Athenna\ncreates to run your command."}),"\n",(0,o.jsxs)(n.p,{children:["Let's suppose we have created a command called ",(0,o.jsx)(n.code,{children:"greet"}),"\nwhich prompts the user his name to say hy:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",metastring:"title=\"Path.commands('Greet.ts')\"",children:"import { BaseCommand } from '@athenna/artisan'\n\nexport class Greet extends BaseCommand {\n  public static signature(): string {\n      return 'greet'\n  }\n\n  public async handle(): Promise<void> {\n    const name = await this.prompt.input('What is your name?')\n\n    this.logger.info(`Hello ${name}!`)\n  }\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:["If you try to run ",(0,o.jsx)(n.code,{children:"greet"})," command in your tests it will\nexceed the timeout since the command will be waiting for\nthe user input name."]}),"\n",(0,o.jsxs)(n.p,{children:["To solve this kind of situation and others, you can create\nyour own Artisan console that will first mock the ",(0,o.jsx)(n.code,{children:"this.prompt.input()"}),"\nmethod and then boot Artisan:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",metastring:"title=\"Path.fixtures('consoles/mock-greet-input.ts')\"",children:"import { Mock } from '@athenna/test'\nimport { Ignite } from '@athenna/core'\nimport { Prompt } from '@athenna/artisan'\n\nconst ignite = await new Ignite().load(import.meta.url, { bootLogs: false })\n\nMock.when(Prompt.prototype, 'input').resolve('Valmir Barbosa')\n\nawait ignite.console(process.argv, { displayName: 'Artisan' })\n"})}),"\n",(0,o.jsx)(n.p,{children:"Now, we can use this new Artisan console file to run the command\nin our test cases:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { Path } from '@athenna/common'\nimport { Test, type Context } from '@athenna/test'\n\nexport default class GreetTest {\n  @Test()\n  public async testGreet({ command }: Context) {\n    const output = await command.run('greet', {\n      path: Path.fixtures('consoles/mock-greet-input.ts') \ud83d\udc48\n    })\n\n    output.assertLogged('Hello Valmir Barbosa!') \u2705\n  }\n}\n"})}),"\n",(0,o.jsx)(n.h2,{id:"mocking-database",children:"Mocking database"}),"\n",(0,o.jsxs)(n.p,{children:["When working with the database library, you might need to mock\nthe database calls in your tests, specially in unitary tests.\nFor this situation, you can use the ",(0,o.jsx)(n.code,{children:"fake"})," connection as your default\nconnection in your ",(0,o.jsx)(n.code,{children:".env.test"})," file:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-dotenv",metastring:'title=".env.test"',children:"DB_CONNECTION=fake\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Next step is to register the Database facade using the\n",(0,o.jsx)(n.code,{children:"DatabaseProvider"})," to be able to access the facade. We\ncould do it inside a ",(0,o.jsx)(n.code,{children:"@BeforeAll()"})," hook. Let's craft\na ",(0,o.jsx)(n.code,{children:"UserServiceTest"})," class to use as an example:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",metastring:'title="UserServiceTest.ts"',children:"import { DatabaseProvider } from '@athenna/database'\nimport { Mock, BeforeAll, AfterEach } from '@athenna/test'\n\nexport default class UserServiceTest {\n  @BeforeAll()\n  public beforeAll() {\n    new DatabaseProvider().register()\n  }\n\n  @AfterEach()\n  public afterEach() {\n    Mock.restoreAll()\n  }\n}\n"})}),"\n",(0,o.jsx)(n.p,{children:"Nice, now we have everything set up to start mocking database calls \ud83e\udd73"}),"\n",(0,o.jsx)(n.admonition,{type:"warning",children:(0,o.jsxs)(n.p,{children:["Never forget the ",(0,o.jsx)(n.code,{children:"Mock.restoreAll()"})," in the ",(0,o.jsx)(n.code,{children:"@AfterEach()"})," hook\nto clean your mocks in each test \ud83d\udc4d"]})}),"\n",(0,o.jsxs)(n.h3,{id:"mocking-the-find-method",children:["Mocking the ",(0,o.jsx)(n.code,{children:"find()"})," method"]}),"\n",(0,o.jsxs)(n.p,{children:["Imagine that our ",(0,o.jsx)(n.code,{children:"UserService"})," has a method called ",(0,o.jsx)(n.code,{children:"findById()"}),"\nthat is responsible to find a user in database by the id using\nan ",(0,o.jsx)(n.code,{children:"User"})," model. To mock this scenario, we could do the following:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { UserService } from '#src/services/UserService'\nimport { Database, DatabaseProvider } from '@athenna/database'\nimport { Test, Mock, BeforeAll, AfterEach, type Context } from '@athenna/test'\n\nexport default class UserServiceTest {\n  @BeforeAll()\n  public beforeEach() {\n    new DatabaseProvider().register()\n  }\n\n  @AfterEach()\n  public afterEach() {\n    Mock.restoreAll()\n  }\n\n  @Test()\n  public async testFindById({ assert }: Context) {\n    Mock.when(Database.driver, 'find').resolve({\n      id: 1,\n      name: 'Antoine Du Hamel'\n    })\n\n    const userService = new UserService()\n    const user = await userService.findById(1) \ud83d\udc48\n\n    assert.calledOnce(Database.driver.find) \u2705\n    assert.deepEqual(user, { id: 1, name: 'Antoine Du Hamel' }) \u2705\n  }\n}\n"})}),"\n",(0,o.jsxs)(n.h3,{id:"mocking-the-create-method",children:["Mocking the ",(0,o.jsx)(n.code,{children:"create()"})," method"]}),"\n",(0,o.jsxs)(n.p,{children:["Now imagine that our ",(0,o.jsx)(n.code,{children:"UserService"})," has a method called ",(0,o.jsx)(n.code,{children:"create()"}),"\nthat is responsible to create a user in database using an ",(0,o.jsx)(n.code,{children:"User"}),"\nmodel. To mock this scenario, we could do the following:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-typescript",children:"import { UserService } from '#src/services/UserService'\nimport { Database, DatabaseProvider } from '@athenna/database'\nimport { Test, Mock, BeforeAll, AfterEach, type Context } from '@athenna/test'\n\nexport default class UserServiceTest {\n  @BeforeAll()\n  public beforeAll() {\n    new DatabaseProvider().register()\n  }\n\n  @AfterEach()\n  public afterEach() {\n    Mock.restoreAll()\n  }\n\n  @Test()\n  public async testCreate({ assert }: Context) {\n    Mock.when(Database.driver, 'create')\n      .withArgs({ name: 'Jo\xe3o Lenon' })\n      .resolve({ id: 1, name: 'Jo\xe3o Lenon', createdAt: new Date() })\n      .withArgs({ name: 'Antoine Du Hamel' })\n      .resolve({ id: 2, name: 'Antoine Du Hamel', createdAt: new Date() })\n\n    const userService = new UserService()\n    const data = { name: 'Antoine Du Hamel' }\n    const user = await userService.create(data) \ud83d\udc48\n\n    assert.containsSubset(user, { id: 2, name: 'Antoine Du Hamel' }) \u2705\n    assert.calledOnceWith(Database.driver.create, data) \u2705\n  }\n}\n"})}),"\n",(0,o.jsx)(n.admonition,{type:"tip",children:(0,o.jsxs)(n.p,{children:["Mocking the methods of the ",(0,o.jsx)(n.code,{children:"Database.driver"})," property gaves you\npower to change the behavior of models and also ",(0,o.jsx)(n.code,{children:"Database"}),"\nfacade calls. You are able to mock any method of the\ndatabase ",(0,o.jsx)(n.a,{href:"/docs/database/query-builder",children:"query builder."})]})})]})}function h(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>i});var s=t(6540);const o={},c=s.createContext(o);function r(e){const n=s.useContext(c);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),s.createElement(c.Provider,{value:n},e.children)}}}]);